<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Ø±ÙŠÙ„Ø² Ø§Ù„Ù‚Ø±Ø¢Ù† v7</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;500;600;700&family=Amiri+Quran&family=Amiri:ital,wght@0,400;0,700;1,400&family=Cairo:wght@300;400;600;700;900&family=Scheherazade+New:wght@400;500;600;700&family=Lateef:wght@400;700&family=Reem+Kufi:wght@400;500;600;700&family=Aref+Ruqaa:wght@400;700&family=Noto+Kufi+Arabic:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/mp4-muxer@5/build/mp4-muxer.js"></script>
<style>
:root{--gold:#f0c040;--dark:#06060e;--acc:#7c3aed;--acc2:#a855f7;--em:#10b981;--rose:#f43f5e;--sky:#38bdf8;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--dark);color:#fff;font-family:'Cairo',sans-serif;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:radial-gradient(ellipse at 12% 12%,rgba(124,58,237,.16) 0%,transparent 45%),
    radial-gradient(ellipse at 88% 88%,rgba(240,192,64,.1) 0%,transparent 45%),
    radial-gradient(ellipse at 55% 5%,rgba(16,185,129,.07) 0%,transparent 35%);
  animation:bp 10s ease-in-out infinite alternate;}
@keyframes bp{0%{opacity:.5}100%{opacity:1}}
.hdr{position:relative;z-index:10;text-align:center;padding:1.5rem 1rem .6rem;
  background:linear-gradient(180deg,rgba(6,6,14,.98) 0%,transparent 100%);}
.hdr-logo{font-size:2rem;font-weight:900;
  background:linear-gradient(135deg,#f0c040,#ff6b9d,#a855f7,#10b981,#38bdf8,#f0c040);
  background-size:300% 300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;animation:rbt 4s ease infinite;}
@keyframes rbt{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
.hdr-sub{color:rgba(255,255,255,.35);font-size:.7rem;margin-top:.2rem;letter-spacing:2px;text-transform:uppercase;direction:ltr;}
.vbadge{display:inline-block;background:linear-gradient(135deg,#f43f5e,#f97316);color:#fff;font-size:.58rem;
  font-weight:900;padding:.14rem .48rem;border-radius:20px;vertical-align:middle;margin-right:.35rem;letter-spacing:1.5px;}
.main{position:relative;z-index:5;display:grid;grid-template-columns:1fr 340px;
  gap:1.3rem;max-width:1320px;margin:0 auto;padding:1rem 1.3rem 2rem;}
@media(max-width:960px){.main{grid-template-columns:1fr;}}
.panel{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);
  border-radius:18px;padding:1.25rem;backdrop-filter:blur(24px);}
.tabs{display:flex;gap:.12rem;border-bottom:1px solid rgba(255,255,255,.07);
  margin-bottom:1rem;overflow-x:auto;scrollbar-width:none;}
.tabs::-webkit-scrollbar{display:none;}
.tab{padding:.4rem .78rem;font-size:.72rem;color:rgba(255,255,255,.38);cursor:pointer;
  border-bottom:2px solid transparent;transition:all .2s;font-weight:700;white-space:nowrap;flex-shrink:0;}
.tab.active{color:var(--gold);border-bottom-color:var(--gold);}
.tc{display:none;}.tc.active{display:block;}
.st{font-size:.65rem;font-weight:800;letter-spacing:3px;text-transform:uppercase;
  color:var(--gold);margin-bottom:.6rem;direction:ltr;display:flex;align-items:center;gap:.4rem;}
.st::before{content:'';width:3px;height:12px;background:var(--gold);border-radius:2px;flex-shrink:0;}
.cg{margin-bottom:.85rem;}
.cl{display:block;font-size:.72rem;color:rgba(255,255,255,.48);margin-bottom:.3rem;font-weight:600;}
select,input[type=number]{width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);
  border-radius:10px;color:#fff;font-family:'Cairo',sans-serif;font-size:.8rem;padding:.5rem .72rem;outline:none;
  transition:border-color .3s;appearance:none;cursor:pointer;}
select:focus,input:focus{border-color:var(--gold);}
select option{background:#0f0f1c;}
.rr{display:flex;align-items:center;gap:.65rem;}
input[type=range]{flex:1;height:4px;padding:0;border:none;background:transparent;accent-color:var(--gold);cursor:pointer;}
.rv{font-size:.74rem;color:var(--gold);font-weight:800;min-width:34px;text-align:right;}
.range-box{background:rgba(240,192,64,.05);border:1px solid rgba(240,192,64,.18);
  border-radius:13px;padding:.9rem;margin-bottom:.9rem;}
.range-row{display:grid;grid-template-columns:1fr auto 1fr;gap:.6rem;align-items:end;}
.rlbl{font-size:.64rem;color:rgba(255,255,255,.38);margin-bottom:.28rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;}
.range-arrow{font-size:1rem;color:var(--gold);text-align:center;padding-bottom:.5rem;}
.dur-box{background:rgba(16,185,129,.07);border:1px solid rgba(16,185,129,.2);
  border-radius:10px;padding:.65rem .9rem;margin:.6rem 0;display:flex;align-items:center;justify-content:space-between;}
.dur-l{font-size:.72rem;color:rgba(255,255,255,.45);}
.dur-note{font-size:.62rem;color:rgba(255,255,255,.25);margin-top:.12rem;}
.dur-r{font-size:1.1rem;color:var(--em);font-weight:900;direction:ltr;}
.qt{width:100%;border-collapse:collapse;font-size:.72rem;}
.qt th{text-align:right;padding:.35rem .45rem;color:rgba(255,255,255,.3);font-size:.63rem;
  font-weight:700;letter-spacing:1px;border-bottom:1px solid rgba(255,255,255,.07);}
.qt td{padding:.38rem .45rem;border-bottom:1px solid rgba(255,255,255,.04);vertical-align:middle;}
.qt tr.qa td{background:rgba(240,192,64,.07);}
.qt tr.qd td{opacity:.4;}
.sp{display:inline-block;padding:.08rem .44rem;border-radius:20px;font-size:.6rem;font-weight:700;}
.spw{background:rgba(255,255,255,.07);color:rgba(255,255,255,.38);}
.spp{background:rgba(240,192,64,.18);color:var(--gold);}
.spd{background:rgba(16,185,129,.14);color:var(--em);}
.synct{width:100%;border-collapse:collapse;font-size:.72rem;}
.synct th{padding:.35rem .4rem;color:rgba(255,255,255,.3);font-size:.62rem;font-weight:700;
  letter-spacing:1px;border-bottom:1px solid rgba(255,255,255,.07);text-align:right;}
.synct td{padding:.3rem .38rem;border-bottom:1px solid rgba(255,255,255,.04);vertical-align:middle;}
.synct input[type=number]{width:64px;padding:.26rem .38rem;font-size:.72rem;text-align:center;}
.am{font-family:'Amiri Quran',serif;font-size:.82rem;color:var(--gold);
  max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;direction:rtl;}
.bg-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.38rem;}
.bgb{padding:.4rem .22rem;border-radius:8px;border:2px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.04);color:rgba(255,255,255,.55);font-size:.64rem;
  cursor:pointer;transition:all .2s;text-align:center;font-family:'Cairo',sans-serif;}
.bgb.active,.bgb:hover{border-color:var(--gold);color:var(--gold);background:rgba(240,192,64,.07);}
.col-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:.28rem;margin-top:.3rem;}
.cb{width:100%;aspect-ratio:1;border-radius:6px;border:2px solid transparent;cursor:pointer;transition:all .2s;}
.cb.active,.cb:hover{border-color:#fff;transform:scale(1.12);}
.upa{border:2px dashed rgba(240,192,64,.25);border-radius:10px;padding:.9rem;text-align:center;
  cursor:pointer;transition:all .3s;position:relative;overflow:hidden;}
.upa:hover{border-color:var(--gold);background:rgba(240,192,64,.04);}
.upa input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.trow{display:flex;align-items:center;justify-content:space-between;padding:.28rem 0;}
.tlbl{font-size:.74rem;color:rgba(255,255,255,.52);font-weight:600;}
.tog{position:relative;width:36px;height:20px;flex-shrink:0;}
.tog input{display:none;}
.ts{position:absolute;inset:0;background:rgba(255,255,255,.12);border-radius:20px;cursor:pointer;transition:.3s;}
.ts::before{content:'';position:absolute;width:14px;height:14px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.3s;}
input:checked+.ts{background:var(--gold);}
input:checked+.ts::before{transform:translateX(16px);}
.btn{width:100%;padding:.72rem;border-radius:10px;border:none;font-family:'Cairo',sans-serif;
  font-size:.86rem;font-weight:700;cursor:pointer;transition:all .26s;position:relative;
  overflow:hidden;margin-bottom:.35rem;display:flex;align-items:center;justify-content:center;gap:.4rem;}
.btn::before{content:'';position:absolute;inset:0;background:rgba(255,255,255,.1);opacity:0;transition:.3s;}
.btn:hover::before{opacity:1;}
.btn:active{transform:scale(.97);}
.btn:disabled{opacity:.4;cursor:not-allowed;}
.btn-gold{background:linear-gradient(135deg,#f0c040,#f97316);color:#000;}
.btn-pur{background:linear-gradient(135deg,#7c3aed,#a855f7);color:#fff;}
.btn-grn{background:linear-gradient(135deg,#059669,#10b981);color:#fff;}
.btn-sky{background:linear-gradient(135deg,#0284c7,#38bdf8);color:#fff;}
.btn-ghost{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.65);}
.btn-stop{background:linear-gradient(135deg,#dc2626,#f43f5e);color:#fff;}
.btn-teal{background:linear-gradient(135deg,#0f766e,#14b8a6);color:#fff;}
.btn-sm{padding:.36rem .62rem;font-size:.7rem;width:auto;margin-bottom:0;}
.preview-panel{display:flex;flex-direction:column;align-items:center;gap:.85rem;position:sticky;top:1rem;}
.phone{position:relative;width:290px;background:#000;border-radius:34px;
  border:3px solid rgba(255,255,255,.13);
  box-shadow:0 0 0 1px rgba(255,255,255,.04),0 25px 65px rgba(0,0,0,.9);overflow:hidden;}
.notch{position:absolute;top:0;left:50%;transform:translateX(-50%);
  width:80px;height:22px;background:#000;border-radius:0 0 13px 13px;z-index:10;}
#rc{width:290px;height:515px;display:block;border-radius:32px;}
.pbar{width:290px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);
  border-radius:13px;padding:.75rem;}
.pinfo{font-size:.68rem;color:rgba(255,255,255,.45);margin-bottom:.38rem;text-align:center;}
.pinfo span{color:var(--gold);font-weight:700;}
.pctrl{display:flex;align-items:center;gap:.42rem;}
.pbtn{width:34px;height:34px;border-radius:50%;border:none;cursor:pointer;font-size:.85rem;
  display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;}
.pbp{background:linear-gradient(135deg,var(--gold),#f97316);color:#000;}
.pbs{background:rgba(244,63,94,.18);color:var(--rose);border:1px solid rgba(244,63,94,.25);}
.pbn{background:rgba(255,255,255,.07);color:rgba(255,255,255,.55);}
.pbtn:hover{transform:scale(1.1);}
.pw{flex:1;background:rgba(255,255,255,.08);border-radius:4px;height:5px;overflow:hidden;cursor:pointer;}
.pp{height:100%;background:linear-gradient(90deg,var(--gold),#f97316);border-radius:4px;width:0%;transition:width .08s;}
.tlbl2{font-size:.62rem;color:rgba(255,255,255,.3);min-width:32px;text-align:right;direction:ltr;}
.rec-status{background:rgba(0,0,0,.35);border:1px solid rgba(244,63,94,.2);
  border-radius:11px;padding:.7rem;margin-bottom:.5rem;display:none;}
.rec-title{font-size:.7rem;color:var(--rose);font-weight:800;margin-bottom:.4rem;display:flex;align-items:center;gap:.4rem;}
.rec-row{display:flex;justify-content:space-between;margin:.12rem 0;}
.rec-lbl{font-size:.65rem;color:rgba(255,255,255,.4);}
.rec-val{font-size:.7rem;color:#fff;font-weight:700;direction:ltr;}
.rec-bar-w{background:rgba(255,255,255,.07);border-radius:4px;height:5px;margin-top:.4rem;overflow:hidden;}
.rec-bar{height:100%;background:linear-gradient(90deg,var(--rose),#f97316);border-radius:4px;width:0%;transition:width .3s;}
.dl-card{background:rgba(14,165,233,.07);border:1px solid rgba(14,165,233,.22);
  border-radius:12px;padding:.85rem;margin-bottom:.4rem;}
.dl-title{font-size:.72rem;font-weight:800;color:#38bdf8;margin-bottom:.5rem;}
.dl-grid{display:grid;grid-template-columns:1fr 1fr;gap:.4rem;margin-bottom:.45rem;}
.dl-note{font-size:.66rem;color:rgba(255,255,255,.35);line-height:1.85;direction:rtl;}
.dl-note b{color:#38bdf8;}
.badge{display:inline-flex;align-items:center;gap:.32rem;font-size:.68rem;padding:.22rem .65rem;
  border-radius:20px;border:1px solid;white-space:nowrap;}
.bg{background:rgba(16,185,129,.1);border-color:rgba(16,185,129,.3);color:var(--em);}
.br{background:rgba(244,63,94,.1);border-color:rgba(244,63,94,.3);color:var(--rose);}
.bdot{width:5px;height:5px;border-radius:50%;background:currentColor;animation:blink 1.3s ease infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.15}}
.log-box{background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.06);border-radius:8px;
  padding:.55rem;max-height:100px;overflow-y:auto;font-size:.63rem;color:rgba(255,255,255,.4);
  direction:ltr;font-family:monospace;line-height:1.7;margin-top:.45rem;}
.lp{margin:0;padding:0;}
.lp.ok{color:var(--em);}
.lp.err{color:var(--rose);}
.lp.info{color:var(--gold);}
.social-bar{position:relative;z-index:10;display:flex;justify-content:center;align-items:center;gap:.7rem;padding:1.1rem 1rem;flex-wrap:wrap;}
.sl{display:flex;align-items:center;gap:.4rem;padding:.48rem .95rem;border-radius:50px;text-decoration:none;
  color:#fff;font-size:.78rem;font-weight:700;font-family:'Cairo',sans-serif;transition:all .3s;
  border:1px solid rgba(255,255,255,.11);background:rgba(255,255,255,.04);position:relative;overflow:hidden;}
.sl::before{content:'';position:absolute;inset:0;opacity:0;transition:.3s;}
.sl:hover{transform:translateY(-3px);border-color:transparent;}
.sl:hover::before{opacity:1;}
.sli{font-size:.9rem;position:relative;z-index:1;}
.slt{position:relative;z-index:1;}
.wa::before{background:linear-gradient(135deg,#25d366,#128c7e);}
.ig::before{background:linear-gradient(135deg,#f09433,#dc2743,#bc1888);}
.fb::before{background:linear-gradient(135deg,#1877f2,#3b5998);}
.yt::before{background:linear-gradient(135deg,#ff0000,#cc0000);}
.footer{position:relative;z-index:10;text-align:center;padding:.75rem;border-top:1px solid rgba(255,255,255,.05);}
.dev{font-size:.76rem;direction:ltr;
  background:linear-gradient(90deg,#f0c040,#f97316,#f43f5e,#a855f7,#10b981,#38bdf8,#f0c040);
  background-size:300% 100%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;animation:rbt 2.5s linear infinite;font-weight:800;letter-spacing:1px;}
::-webkit-scrollbar{width:3px;height:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:rgba(240,192,64,.3);border-radius:3px;}
.divider{border:none;border-top:1px solid rgba(255,255,255,.06);margin:.7rem 0;}
.note{font-size:.66rem;color:rgba(255,255,255,.28);line-height:1.8;direction:rtl;}
.fr{display:flex;gap:.4rem;align-items:center;flex-wrap:wrap;}
#ls-mark-btn{background:linear-gradient(135deg,#059669,#10b981);transition:background .15s,color .15s;}
@keyframes markFlash{0%{transform:scale(1)}50%{transform:scale(1.04)}100%{transform:scale(1)}}
#ls-mark-btn:active{animation:markFlash .15s;}

</style>
</head>
<body>

<div class="hdr">
  <div class="hdr-logo"><span class="vbadge">V7</span>ğŸ•Œ Ø±ÙŠÙ„Ø² Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</div>
  <div class="hdr-sub">v7 Â· Nature Backgrounds Â· Smart Split Â· Verse Numbers Â· Mobile Ready</div>
</div>

<div class="main">

<!-- â•â•â•â• LEFT â•â•â•â• -->
<div class="panel">
  <div class="tabs">
    <div class="tab active" onclick="sTab('range')">ğŸ¯ Ø§Ù„Ø¢ÙŠØ§Øª</div>
    <div class="tab" onclick="sTab('sync')">â±ï¸ Ø§Ù„ØªÙˆÙ‚ÙŠØª</div>
    <div class="tab" onclick="sTab('design')">ğŸ¨ Ø§Ù„ØªØµÙ…ÙŠÙ…</div>
    <div class="tab" onclick="sTab('text')">âœï¸ Ø§Ù„Ù†Øµ</div>
    <div class="tab" onclick="sTab('livesync')">ğŸ›ï¸ Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¨Ø§Ø´Ø±Ø©</div>
    <div class="tab" onclick="sTab('export')">ğŸ“¥ ØªÙ†Ø²ÙŠÙ„</div>
  </div>

  <!-- RANGE TAB -->
  <div class="tc active" id="tc-range">
    <div class="cg">
      <label class="cl">Ø§Ù„Ø³ÙˆØ±Ø©</label>
      <select id="s-surah" onchange="onSurahChange()"></select>
    </div>
    <div class="cg">
      <label class="cl">Ø§Ù„Ù‚Ø§Ø±Ø¦</label>
      <select id="s-reciter" onchange="onReciterChange()"></select>
    </div>
    <div class="divider"></div>
    <div class="st">Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¢ÙŠØ§Øª</div>
    <div class="range-box">
      <div class="range-row">
        <div><div class="rlbl">Ù…Ù† Ø¢ÙŠØ©</div><select id="s-from" onchange="onRangeChange()"></select></div>
        <div class="range-arrow">â†’</div>
        <div><div class="rlbl">Ø¥Ù„Ù‰ Ø¢ÙŠØ©</div><select id="s-to" onchange="onRangeChange()"></select></div>
      </div>
    </div>
    <div class="dur-box" id="dur-box">
      <div><div class="dur-l">Ù…Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</div><div class="dur-note">ØªÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø£ØµÙˆØ§Øª</div></div>
      <div><div class="dur-r" id="total-dur-lbl">â€” : â€”</div><div style="font-size:.6rem;color:rgba(255,255,255,.25);text-align:center;" id="ayah-cnt">0 Ø¢ÙŠØ©</div></div>
    </div>
    <div class="st">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ„Ø§ÙˆØ©</div>
    <div style="overflow-x:auto;max-height:250px;overflow-y:auto;">
      <table class="qt"><thead><tr><th>Ø¢ÙŠØ©</th><th>Ø§Ù„Ù†Øµ</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
        <tbody id="queue-body"><tr><td colspan="4" style="text-align:center;padding:1rem;color:rgba(255,255,255,.25);">Ø§Ø®ØªØ± Ø³ÙˆØ±Ø©...</td></tr></tbody>
      </table>
    </div>
    <div class="divider"></div>
    <div class="fr">
      <button class="btn btn-gold" style="flex:1;" onclick="startPlayback()">â–¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙ„Ø§ÙˆØ©</button>
      <button class="btn btn-stop btn-sm" onclick="stopAll()" id="btn-stop" disabled>â¹</button>
    </div>
    <button class="btn btn-sky" onclick="preloadAll()">ğŸ” ÙƒØ´Ù Ù…Ø¯Ø¯ Ø§Ù„ØµÙˆØª Ù…Ø³Ø¨Ù‚Ø§Ù‹</button>
  </div>

  <!-- SYNC TAB -->
  <div class="tc" id="tc-sync">
    <div class="st">Ø¶Ø¨Ø· Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</div>
    <div class="note" style="margin-bottom:.8rem;padding:.6rem;background:rgba(255,255,255,.03);border-radius:8px;border:1px solid rgba(255,255,255,.06);">
      <b style="color:var(--gold)">Ù…ÙˆØ¬Ø¨ (+)</b> = Ø§Ù„Ù†Øµ ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØµÙˆØª<br>
      <b style="color:var(--sky)">Ø³Ø§Ù„Ø¨ (-)</b> = Ø§Ù„Ù†Øµ ÙŠØ¸Ù‡Ø± Ù‚Ø¨Ù„ Ø§Ù„ØµÙˆØª<br>
      <b style="color:var(--em)">ØµÙØ± (0)</b> = Ø§Ù„Ù†Øµ Ù…Ø¹ Ø§Ù„ØµÙˆØª ØªÙ…Ø§Ù…Ø§Ù‹
    </div>
    <div class="cg">
      <label class="cl">ØªØ£Ø®ÙŠØ± Ø¹Ø§Ù… Ù„ÙƒÙ„ Ø§Ù„Ø¢ÙŠØ§Øª (Ø«Ø§Ù†ÙŠØ©)</label>
      <div class="rr"><input type="range" id="global-off" min="-3" max="6" step="0.1" value="0" oninput="applyGlobal(this.value)"><span class="rv" id="gov">0.0s</span></div>
    </div>
    <div class="cg">
      <label class="cl">ÙØ¬ÙˆØ© Ø¨ÙŠÙ† Ø§Ù„Ø¢ÙŠØ§Øª (Ø«Ø§Ù†ÙŠØ©)</label>
      <div class="rr"><input type="range" id="gap-r" min="0" max="3" step="0.25" value="0.5" oninput="S.gap=parseFloat(this.value);document.getElementById('gv').textContent=this.value+'s'"><span class="rv" id="gv">0.5s</span></div>
    </div>
    <div class="st" style="margin-top:.6rem;">Ø¶Ø¨Ø· ÙƒÙ„ Ø¢ÙŠØ© Ø¹Ù„Ù‰ Ø­Ø¯Ø©</div>
    <div style="overflow-x:auto;max-height:300px;overflow-y:auto;">
      <table class="synct"><thead><tr><th>Ø¢ÙŠØ©</th><th>Ø§Ù„Ù†Øµ</th><th>ØªØ£Ø®ÙŠØ± (Ø«)</th><th>Ø§Ø®ØªØ¨Ø±</th></tr></thead>
        <tbody id="sync-body"><tr><td colspan="4" style="text-align:center;padding:1rem;color:rgba(255,255,255,.25);">Ø­Ø¯Ø¯ Ø§Ù„Ø¢ÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹...</td></tr></tbody>
      </table>
    </div>
    <div class="divider"></div>
    <button class="btn btn-ghost" onclick="resetSync()">â†º Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ØªÙˆÙ‚ÙŠØª</button>
  </div>

  <!-- DESIGN TAB -->
  <div class="tc" id="tc-design">
    <div class="st">Ø§Ù„Ø®Ù„ÙÙŠØ©</div>
    <div class="bg-grid" id="bg-grid">
      <button class="bgb active" onclick="setBg('g1')" data-b="g1">ğŸŒ™ Ù„ÙŠÙ„ÙŠ</button>
      <button class="bgb" onclick="setBg('g2')" data-b="g2">ğŸ”® Ø¨Ù†ÙØ³Ø¬ÙŠ</button>
      <button class="bgb" onclick="setBg('g3')" data-b="g3">ğŸŒ¿ Ø£Ø®Ø¶Ø±</button>
      <button class="bgb" onclick="setBg('g4')" data-b="g4">ğŸŒ… ØºØ±ÙˆØ¨</button>
      <button class="bgb" onclick="setBg('g5')" data-b="g5">ğŸŒŠ Ø¨Ø­Ø±</button>
      <button class="bgb" onclick="setBg('rb')" data-b="rb">ğŸŒˆ Ù‚ÙˆØ³ Ù‚Ø²Ø­</button>
      <button class="bgb" onclick="setBg('stars')" data-b="stars">â­ Ù†Ø¬ÙˆÙ…</button>
      <button class="bgb" onclick="setBg('geo')" data-b="geo">ğŸ”· Ù‡Ù†Ø¯Ø³ÙŠ</button>
      <button class="bgb" onclick="setBg('dark')" data-b="dark">â¬› Ø£Ø³ÙˆØ¯</button>
    </div>
    <div class="st" style="margin-top:.9rem;">Ø®Ù„ÙÙŠØ§Øª Ø·Ø¨ÙŠØ¹ÙŠØ© Ù…ØªØ­Ø±ÙƒØ© ğŸŒ¿</div>
    <div class="bg-grid">
      <button class="bgb" onclick="setBg('waterfall')" data-b="waterfall">ğŸ’§ Ø´Ù„Ø§Ù„</button>
      <button class="bgb" onclick="setBg('petals')" data-b="petals">ğŸŒ¸ ÙˆØ±Ø¯</button>
      <button class="bgb" onclick="setBg('forest')" data-b="forest">ğŸŒ² ØºØ§Ø¨Ø©</button>
      <button class="bgb" onclick="setBg('rain')" data-b="rain">ğŸŒ§ï¸ Ù…Ø·Ø±</button>
      <button class="bgb" onclick="setBg('aurora')" data-b="aurora">ğŸŒŒ Ø£Ø¶ÙˆØ§Ø¡</button>
      <button class="bgb" onclick="setBg('desert')" data-b="desert">ğŸœï¸ ØµØ­Ø±Ø§Ø¡</button>
    </div>
    <div class="st" style="margin-top:.9rem;">Ø®Ù„ÙÙŠØ© Ù…Ø®ØµØµØ© (ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ)</div>
    <div class="upa"><input type="file" id="wp-input" accept="image/*,video/*" onchange="onWpUpload(event)">
      <div style="font-size:1.5rem;">ğŸ–¼ï¸ğŸ¬</div>
      <div style="font-size:.7rem;color:rgba(255,255,255,.4);margin-top:.25rem;">ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ Ø·Ø¨ÙŠØ¹ÙŠ</div>
      <div style="font-size:.66rem;color:var(--em);margin-top:.2rem;" id="wp-name"></div>
    </div>
    <button class="btn btn-ghost" style="margin-top:.3rem;padding:.38rem;" onclick="clearWp()">ğŸ—‘ï¸ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©</button>
    <hr class="divider">
    <div class="st">Ù„ÙˆÙ† Ø§Ù„Ù†Øµ</div>
    <div class="col-grid">
      <button class="cb active" style="background:#ffd700" onclick="setTc('#ffd700')"></button>
      <button class="cb" style="background:#ffffff" onclick="setTc('#ffffff')"></button>
      <button class="cb" style="background:#a8edea" onclick="setTc('#a8edea')"></button>
      <button class="cb" style="background:#fed6e3" onclick="setTc('#fed6e3')"></button>
      <button class="cb" style="background:#96fbc4" onclick="setTc('#96fbc4')"></button>
      <button class="cb" style="background:#ffeaa7" onclick="setTc('#ffeaa7')"></button>
      <button class="cb" style="background:#ff9a9e" onclick="setTc('#ff9a9e')"></button>
      <button class="cb" style="background:#c7f2ff" onclick="setTc('#c7f2ff')"></button>
    </div>
    <hr class="divider">
    <div class="trow"><span class="tlbl">Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ±Ø© ÙˆØ§Ù„Ø¢ÙŠØ©</span><label class="tog"><input type="checkbox" id="t-sname" checked><span class="ts"></span></label></div>
    <div class="trow"><span class="tlbl">Ø¬Ø³ÙŠÙ…Ø§Øª Ù…ØªØ·Ø§ÙŠØ±Ø©</span><label class="tog"><input type="checkbox" id="t-parts" checked onchange="S.showParts=this.checked"><span class="ts"></span></label></div>
    <div class="trow"><span class="tlbl">Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠ</span><label class="tog"><input type="checkbox" id="t-geo" checked onchange="S.showGeo=this.checked"><span class="ts"></span></label></div>
  </div>

  <!-- TEXT TAB -->
  <div class="tc" id="tc-text">
    <div class="st">Ø§Ù„Ø®Ø· Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ</div>
    <div class="cg">
      <label class="cl">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·</label>
      <select id="s-font" onchange="onFontChange(this.value)">
        <option value="Amiri Quran">ğŸ•Œ Ø£Ù…ÙŠØ±ÙŠ Ù‚Ø±Ø¢Ù† (Ù…ØµØ­ÙÙŠ)</option>
        <option value="Scheherazade New">ğŸ“œ Ø´Ù‡Ø±Ø²Ø§Ø¯ â€” ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ ÙØ§Ø®Ø±</option>
        <option value="Lateef">âœ¨ Ù„Ø·ÙŠÙ â€” Ø±Ø´ÙŠÙ‚ Ù†Ø§Ø¹Ù…</option>
        <option value="Noto Naskh Arabic">ğŸ“– Ù†Ø³Ø® Ø¹Ø±Ø¨ÙŠ â€” ÙˆØ§Ø¶Ø­</option>
        <option value="Amiri">ğŸŒ™ Ø£Ù…ÙŠØ±ÙŠ â€” Ø£Ù†ÙŠÙ‚</option>
        <option value="Reem Kufi">ğŸ”· Ø±ÙŠÙ… ÙƒÙˆÙÙŠ â€” Ù‡Ù†Ø¯Ø³ÙŠ</option>
        <option value="Aref Ruqaa">ğŸ–Šï¸ Ø¹Ø§Ø±Ù Ø±Ù‚Ø¹Ø© â€” Ø®Ø·ÙŠ</option>
        <option value="Noto Kufi Arabic">ğŸ”¶ Ù†ÙˆØªÙˆ ÙƒÙˆÙÙŠ â€” Ø­Ø¯ÙŠØ«</option>
      </select>
    </div>
    <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø®Ø· -->
    <div id="font-preview" style="background:rgba(0,0,0,.35);border:1px solid rgba(240,192,64,.2);border-radius:10px;padding:.7rem;margin-bottom:.6rem;text-align:center;direction:rtl;">
      <div id="font-preview-txt" style="font-size:1.5rem;color:var(--gold);font-family:'Amiri Quran',serif;line-height:1.8;">Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù</div>
      <div style="font-size:.6rem;color:rgba(255,255,255,.25);margin-top:.25rem;">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø®Ø·</div>
    </div>

    <div class="st">Ø­Ø¬Ù… Ø§Ù„Ø®Ø·</div>
    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:.3rem;margin-bottom:.7rem;">
      <button class="bgb" onclick="setFontSize(22)" id="fs-btn-22">ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹<br><span style="font-size:.55rem;opacity:.6;">22</span></button>
      <button class="bgb" onclick="setFontSize(28)" id="fs-btn-28">ØµØºÙŠØ±<br><span style="font-size:.55rem;opacity:.6;">28</span></button>
      <button class="bgb active" onclick="setFontSize(34)" id="fs-btn-34">Ù…ØªÙˆØ³Ø·<br><span style="font-size:.55rem;opacity:.6;">34</span></button>
      <button class="bgb" onclick="setFontSize(42)" id="fs-btn-42">ÙƒØ¨ÙŠØ±<br><span style="font-size:.55rem;opacity:.6;">42</span></button>
      <button class="bgb" onclick="setFontSize(52)" id="fs-btn-52">ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹<br><span style="font-size:.55rem;opacity:.6;">52</span></button>
    </div>
    <div class="rr" style="margin-bottom:.7rem;">
      <input type="range" id="fs-r" min="16" max="72" value="34" oninput="setFontSizeRaw(parseInt(this.value))">
      <span class="rv" id="fs-v">34</span>
    </div>

    <div class="st">Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø³Ø·Ø±</div>
    <div class="rr"><input type="range" id="lh-r" min="1.2" max="3.5" step="0.1" value="1.88" oninput="S.lineHeight=parseFloat(this.value);document.getElementById('lh-v').textContent=parseFloat(this.value).toFixed(1)"><span class="rv" id="lh-v">1.9</span></div>
    <div class="st" style="margin-top:.8rem;">ØªØ¨Ø§Ø¹Ø¯ Ø§Ù„Ø­Ø±ÙˆÙ</div>
    <div class="rr"><input type="range" id="ls-r" min="-2" max="8" step="0.5" value="0" oninput="S.letterSpacing=parseFloat(this.value);document.getElementById('ls-v').textContent=this.value+'px'"><span class="rv" id="ls-v">0px</span></div>
    <div class="st" style="margin-top:.8rem;">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø± ÙÙŠ ÙƒÙ„ Ø´Ø±ÙŠØ­Ø©</div>
    <div class="note" style="margin-bottom:.5rem;">Ø§Ù„Ø¢ÙŠØ§Øª Ø§Ù„Ø·ÙˆÙŠÙ„Ø© ØªÙÙ‚Ø³ÙÙ‘Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø­Ø³Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…</div>
    <div class="rr"><input type="range" id="spl-r" min="1" max="8" step="1" value="3" oninput="S.linesPerSlide=parseInt(this.value);document.getElementById('spl-v').textContent=this.value+' Ø£Ø³Ø·Ø±'"><span class="rv" id="spl-v">3 Ø£Ø³Ø·Ø±</span></div>
    <hr class="divider">

    <!-- â•â• Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ â•â• -->
    <div class="st">Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø¢ÙŠØ§Øª âœ¨</div>
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:.38rem;margin-bottom:.75rem;" id="anim-grid">
      <button class="bgb active" onclick="setAnim('fade')" data-a="fade">ğŸŒ«ï¸ Ø¨Ù‡ØªØ§Ù†<br><span style="font-size:.55rem;opacity:.6;">Fade</span></button>
      <button class="bgb" onclick="setAnim('slideUp')" data-a="slideUp">â¬†ï¸ ØµØ¹ÙˆØ¯<br><span style="font-size:.55rem;opacity:.6;">Slide Up</span></button>
      <button class="bgb" onclick="setAnim('slideDown')" data-a="slideDown">â¬‡ï¸ Ù†Ø²ÙˆÙ„<br><span style="font-size:.55rem;opacity:.6;">Slide Down</span></button>
      <button class="bgb" onclick="setAnim('slideRight')" data-a="slideRight">â¡ï¸ ÙŠÙ…ÙŠÙ†<br><span style="font-size:.55rem;opacity:.6;">Slide Right</span></button>
      <button class="bgb" onclick="setAnim('slideLeft')" data-a="slideLeft">â¬…ï¸ ÙŠØ³Ø§Ø±<br><span style="font-size:.55rem;opacity:.6;">Slide Left</span></button>
      <button class="bgb" onclick="setAnim('zoomIn')" data-a="zoomIn">ğŸ” ØªÙƒØ¨ÙŠØ±<br><span style="font-size:.55rem;opacity:.6;">Zoom In</span></button>
      <button class="bgb" onclick="setAnim('zoomOut')" data-a="zoomOut">ğŸ” ØªØµØºÙŠØ±<br><span style="font-size:.55rem;opacity:.6;">Zoom Out</span></button>
      <button class="bgb" onclick="setAnim('flipY')" data-a="flipY">ğŸ”„ Ù‚Ù„Ø¨<br><span style="font-size:.55rem;opacity:.6;">Flip</span></button>
      <button class="bgb" onclick="setAnim('bounce')" data-a="bounce">ğŸ€ Ø§Ø±ØªØ¯Ø§Ø¯<br><span style="font-size:.55rem;opacity:.6;">Bounce</span></button>
      <button class="bgb" onclick="setAnim('glow')" data-a="glow">âœ¨ ÙˆÙ…ÙŠØ¶<br><span style="font-size:.55rem;opacity:.6;">Glow</span></button>
    </div>

    <hr class="divider">
    <div class="trow">
      <span class="tlbl">Ø¥Ø¸Ù‡Ø§Ø± Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ© Ø¨Ø´ÙƒÙ„ Ù…ØµØ­Ù ï´¿Ù¥ï´¾</span>
      <label class="tog"><input type="checkbox" id="t-vnum" onchange="S.showVerseNum=this.checked"><span class="ts"></span></label>
    </div>
    <div class="note" style="margin-top:.3rem;">ÙŠÙØ¶Ø§Ù Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ© Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù†Øµ</div>
  </div>

  <!-- LIVE SYNC TAB -->
  <div class="tc" id="tc-livesync">
    <div class="st">ğŸ›ï¸ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</div>
    <div class="note" style="margin-bottom:.85rem;padding:.65rem .8rem;background:rgba(240,192,64,.05);border-radius:10px;border:1px solid rgba(240,192,64,.18);line-height:1.95;">
      <b style="color:var(--gold)">ÙƒÙŠÙ ØªØ³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø§ØµÙŠØ©ØŸ</b><br>
      â‘  Ø§Ø±ÙØ¹ ØµÙˆØªÙƒ Ø§Ù„Ø®Ø§Øµ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØµÙˆØª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ<br>
      â‘¡ Ø§Ø¶ØºØ· <b style="color:var(--sky)">â–¶ Ø´ØºÙ‘Ù„</b> ÙˆØ³ÙŠØ¨Ø¯Ø£ Ø§Ù„ØµÙˆØª ÙˆØ§Ù„ÙƒÙ„Ø§Ù… Ù…Ø¹Ø§Ù‹<br>
      â‘¢ Ø§Ø¶ØºØ· <b style="color:var(--em)">[ ØªØ­Ø¯ÙŠØ¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¢ÙŠØ© ]</b> Ø£Ùˆ <b style="color:var(--em)">Space</b> ÙÙŠ Ø§Ù„Ù„Ø­Ø¸Ø© Ø§Ù„ØªÙŠ ØªØ¨Ø¯Ø£ ÙÙŠÙ‡Ø§ ÙƒÙ„ Ø¢ÙŠØ©<br>
      â‘£ ÙŠÙØ­ÙØ¸ Ø§Ù„ØªÙˆÙ‚ÙŠØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
    </div>

    <!-- Ø±ÙØ¹ ØµÙˆØª Ù…Ø®ØµØµ -->
    <div class="cg">
      <label class="cl">ğŸ™ï¸ ØµÙˆØª Ù…Ø®ØµØµ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <div class="upa" id="ls-audio-upa">
        <input type="file" id="ls-audio-file" accept="audio/*" onchange="onLsAudioUpload(event)">
        <div style="font-size:1.3rem;">ğŸµ</div>
        <div style="font-size:.7rem;color:rgba(255,255,255,.45);margin-top:.22rem;">Ø§Ø±ÙØ¹ MP3 / WAV / M4A</div>
        <div style="font-size:.66rem;color:var(--em);margin-top:.2rem;" id="ls-audio-name"></div>
      </div>
      <button class="btn btn-ghost btn-sm" style="margin-top:.3rem;" onclick="clearLsAudio()">ğŸ—‘ï¸ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø®ØµØµ</button>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø®ØµØµ -->
    <div id="ls-audio-bar" style="display:none;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:.6rem .8rem;margin-bottom:.7rem;">
      <audio id="ls-audio-el" style="width:100%;height:28px;margin-bottom:.3rem;" controls></audio>
    </div>

    <!-- Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¢ÙŠØ§Øª -->
    <div style="background:rgba(124,58,237,.08);border:1px solid rgba(124,58,237,.25);border-radius:12px;padding:.75rem .9rem;margin-bottom:.8rem;display:flex;align-items:center;justify-content:space-between;">
      <div>
        <div style="font-size:.72rem;color:rgba(255,255,255,.55);">Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
        <div id="ls-cur-verse-txt" style="font-family:'Amiri Quran',serif;font-size:1.08rem;color:var(--gold);direction:rtl;line-height:1.85;max-width:240px;margin-top:.18rem;">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ´ØºÙŠÙ„...</div>
      </div>
      <div style="text-align:center;flex-shrink:0;margin-right:.5rem;">
        <div style="font-size:1.8rem;font-weight:900;color:var(--acc2);" id="ls-verse-num">â€”</div>
        <div style="font-size:.6rem;color:rgba(255,255,255,.35);">/ <span id="ls-total-num">â€”</span></div>
      </div>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-bottom:.5rem;">
      <button class="btn btn-pur" id="ls-play-btn" onclick="lsTogglePlay()">â–¶ Ø´ØºÙ‘Ù„</button>
      <button class="btn btn-stop" onclick="lsStop()">â¹ Ø¥ÙŠÙ‚Ø§Ù</button>
    </div>

    <!-- Ø²Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¢ÙŠØ© â€” Ø§Ù„Ø£Ù‡Ù… -->
    <button class="btn btn-grn" id="ls-mark-btn" onclick="lsMark()" disabled
      style="font-size:1rem;padding:.85rem;letter-spacing:.5px;position:relative;overflow:hidden;">
      âš¡ ØªØ­Ø¯ÙŠØ¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ© &nbsp;(Space)
    </button>
    <div style="font-size:.62rem;color:rgba(255,255,255,.25);text-align:center;margin:.22rem 0 .6rem;">Ø§Ø¶ØºØ· Ù…ÙØªØ§Ø­ Space Ø£Ùˆ Ø§Ù„Ø²Ø± Ø£Ø¹Ù„Ø§Ù‡</div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
    <div class="st" style="margin-top:.5rem;">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</div>
    <div style="overflow-x:auto;max-height:220px;overflow-y:auto;">
      <table class="synct" id="ls-result-tbl">
        <thead><tr><th>Ø¢ÙŠØ©</th><th>Ø§Ù„Ù†Øµ</th><th>ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
        <tbody id="ls-result-body">
          <tr><td colspan="4" style="text-align:center;padding:.8rem;color:rgba(255,255,255,.25);">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬...</td></tr>
        </tbody>
      </table>
    </div>
    <div class="divider"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;">
      <button class="btn btn-gold" onclick="lsApplyToSync()">âœ… ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</button>
      <button class="btn btn-ghost" onclick="lsReset()">â†º Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø¯Ø¡</button>
    </div>
  </div>

  <!-- EXPORT TAB -->
  <div class="tc" id="tc-export">
    <div class="dur-box" style="margin-bottom:.8rem;">
      <div><div class="dur-l">Ù…Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (ØªÙ„Ù‚Ø§Ø¦ÙŠØ©)</div><div class="dur-note">Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙŠÙ†ØªÙ‡ÙŠ Ù…Ø¹ Ù†Ù‡Ø§ÙŠØ© Ø¢Ø®Ø± Ø¢ÙŠØ©</div></div>
      <div class="dur-r" id="exp-dur">â€” : â€”</div>
    </div>
    <div class="cg"><label class="cl">Ø¬ÙˆØ¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</label>
      <select id="s-qual"><option value="4000000">Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹ (4 Mbps)</option><option value="2500000" selected>Ø¹Ø§Ù„ÙŠØ© (2.5 Mbps)</option><option value="1500000">Ù…ØªÙˆØ³Ø·Ø© (1.5 Mbps)</option></select></div>
    <div class="cg"><label class="cl">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø·Ø§Ø±Ø§Øª</label>
      <select id="s-fps"><option value="30" selected>30 fps (Ø±ÙŠÙ„Ø²)</option><option value="25">25 fps</option><option value="60">60 fps</option></select></div>

    <!-- â•â• ØµÙŠØºØ© Ø§Ù„ØªØµØ¯ÙŠØ± â•â• -->
    <div class="st" style="margin-top:.6rem;">ØµÙŠØºØ© Ø§Ù„ØªØµØ¯ÙŠØ±</div>
    <div style="display:flex;gap:.6rem;margin-bottom:.75rem;">
      <label style="flex:1;cursor:pointer;">
        <div id="fmt-mp4-box" style="border:2px solid var(--gold);background:rgba(240,192,64,.08);border-radius:12px;padding:.6rem .75rem;display:flex;align-items:center;gap:.5rem;transition:all .2s;">
          <div style="width:16px;height:16px;border-radius:50%;border:2px solid var(--gold);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
            <div id="fmt-mp4-dot" style="width:8px;height:8px;border-radius:50%;background:var(--gold);transition:.2s;"></div>
          </div>
          <div>
            <div style="font-size:.75rem;font-weight:800;color:var(--gold);">MP4 <span style="font-size:.58rem;background:linear-gradient(135deg,#f43f5e,#f97316);color:#fff;padding:.08rem .32rem;border-radius:20px;margin-right:.2rem;">Ù…ÙˆØµÙ‰ Ø¨Ù‡</span></div>
            <div style="font-size:.6rem;color:rgba(255,255,255,.35);">H.264 + AAC</div>
          </div>
        </div>
        <input type="radio" name="exp-fmt" value="mp4" id="fmt-mp4" checked style="display:none;" onchange="onFmtChange()">
      </label>
      <label style="flex:1;cursor:pointer;">
        <div id="fmt-webm-box" style="border:2px solid rgba(255,255,255,.1);background:rgba(255,255,255,.03);border-radius:12px;padding:.6rem .75rem;display:flex;align-items:center;gap:.5rem;transition:all .2s;">
          <div style="width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.3);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
            <div id="fmt-webm-dot" style="width:8px;height:8px;border-radius:50%;background:transparent;transition:.2s;"></div>
          </div>
          <div>
            <div style="font-size:.75rem;font-weight:800;color:rgba(255,255,255,.65);">WebM</div>
            <div style="font-size:.6rem;color:rgba(255,255,255,.35);">VP8 / VP9</div>
          </div>
        </div>
        <input type="radio" name="exp-fmt" value="webm" id="fmt-webm" style="display:none;" onchange="onFmtChange()">
      </label>
    </div>

    <!-- â•â• Turbo MP4 (WebCodecs) â•â• -->
    <div id="turbo-box" style="background:rgba(56,189,248,.06);border:1px solid rgba(56,189,248,.22);border-radius:12px;padding:.72rem .9rem;margin-bottom:.8rem;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.38rem;">
        <div style="font-size:.75rem;font-weight:800;color:#38bdf8;">âš¡ Turbo MP4 <span style="font-size:.56rem;background:rgba(56,189,248,.18);border:1px solid rgba(56,189,248,.3);color:#7dd3fc;padding:.08rem .32rem;border-radius:20px;margin-right:.25rem;">(WebCodecs)</span></div>
        <label class="tog"><input type="checkbox" id="turbo-chk" checked onchange="onTurboChange()"><span class="ts"></span></label>
      </div>
      <div style="font-size:.63rem;color:rgba(255,255,255,.42);line-height:1.85;">
        Ø£Ø³Ø±Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©. Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¬ÙˆØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ù‰ <b style="color:rgba(255,255,255,.6);">FFmpeg</b> Ø¹Ù†Ø¯ Ø¹Ø¯Ù… Ø§Ù„Ø¯Ø¹Ù….
      </div>
      <div id="turbo-support" style="margin-top:.32rem;font-size:.62rem;"></div>
    </div>

    <div class="rec-status" id="rec-status">
      <div class="rec-title"><div class="bdot" style="background:var(--rose);"></div><span id="rec-mode-lbl">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±...</span></div>
      <div class="rec-row"><span class="rec-lbl">Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</span><span class="rec-val" id="rec-cur">â€”</span></div>
      <div class="rec-row"><span class="rec-lbl">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ:</span><span class="rec-val" id="rec-el">0:00</span></div>
      <div class="rec-row"><span class="rec-lbl">Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:</span><span class="rec-val" id="rec-tot">â€”</span></div>
      <div class="rec-bar-w"><div class="rec-bar" id="rec-bar"></div></div>
    </div>
    <div class="fr" style="margin-bottom:.5rem;">
      <div class="badge bg" id="stat-badge"><div class="bdot"></div>Ø¬Ø§Ù‡Ø²</div>
      <div class="badge br" id="rec-badge" style="display:none;"><div class="bdot"></div>ÙŠØ³Ø¬Ù„</div>
    </div>
    <button class="btn btn-gold" id="btn-rec" onclick="startRecordingSmart()">ğŸ¬ ØªØµØ¯ÙŠØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (MP4)</button>
    <button class="btn btn-stop" onclick="stopRecordingSmart()" id="btn-stop-rec" disabled>â¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØµØ¯ÙŠØ±</button>
    <div class="divider"></div>
    <div class="st">ØªÙ†Ø²ÙŠÙ„ ÙˆÙ…Ø´Ø§Ø±ÙƒØ© ğŸ“±</div>
    <div class="dl-card">
      <div class="dl-title">ğŸ“² ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„</div>
      <div id="dl-direct-area" style="margin-bottom:.4rem;display:none;">
        <!-- Ø±Ø§Ø¨Ø· ØªÙ†Ø²ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± ÙŠÙÙ†Ø´Ø£ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
      </div>
      <div class="dl-grid">
        <button class="btn btn-gold btn-sm" style="width:100%;margin:0;" onclick="dlAs('mp4')">ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ MP4</button>
        <button class="btn btn-teal btn-sm" style="width:100%;margin:0;" onclick="dlAs('webm')">ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ WebM</button>
      </div>
      <button class="btn btn-sky btn-sm" style="width:100%;margin-bottom:.3rem;margin-top:.3rem;" onclick="shareVideo()">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© (ÙˆØ§ØªØ³Ø§Ø¨ / ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…...)</button>
      <div class="dl-note">
        <b>ğŸ¯ MP4 (H.264+AAC):</b> ÙŠØ´ØªØºÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ iPhone / Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ / ÙƒÙ…Ø¨ÙŠÙˆØªØ±<br>
        <b>ğŸ“± Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯:</b> MP4 â† ÙŠÙØ­ÙØ¸ ÙÙŠ Ø§Ù„Ø¬Ø§Ù„ÙŠØ±ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø©<br>
        <b>ğŸ iPhone:</b> MP4 â† "Ø­ÙØ¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ" ÙÙŠ Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ
      </div>
    </div>
    <button class="btn btn-grn" onclick="dlFrame()">ğŸ–¼ï¸ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© PNG</button>
    <div class="log-box" id="log-box"><p class="lp info">[ Quran Reels v7 â€” Ø¬Ø§Ù‡Ø² âœ… ]</p></div>
  </div>
</div>

<!-- â•â•â•â• RIGHT: PREVIEW â•â•â•â• -->
<div class="preview-panel">
  <div class="fr">
    <div class="badge bg" id="live-badge"><div class="bdot"></div>Ù…Ø¹Ø§ÙŠÙ†Ø©</div>
    <div class="badge" style="background:rgba(240,192,64,.1);border-color:rgba(240,192,64,.3);color:var(--gold);display:none;" id="playing-badge"><div class="bdot" style="background:var(--gold);"></div>ÙŠØ´ØºÙ„</div>
    <div class="badge br" id="rec-live-badge" style="display:none;"><div class="bdot"></div>RECâ—</div>
  </div>
  <div class="phone"><div class="notch"></div><canvas id="rc" width="540" height="960"></canvas></div>
  <div class="pbar">
    <div class="pinfo">Ø¢ÙŠØ© <span id="pl-cur">â€”</span> / <span id="pl-tot">â€”</span> Â· <span id="pl-surah">â€”</span> Â· <span id="pl-time" style="direction:ltr;display:inline-block;">0:00</span></div>
    <div class="pctrl">
      <button class="pbtn pbn" onclick="prevAyah()">â®</button>
      <button class="pbtn pbp" id="main-play" onclick="togglePlay()">â–¶</button>
      <button class="pbtn pbs" onclick="stopAll()">â¹</button>
      <button class="pbtn pbn" onclick="nextAyah()">â­</button>
      <div class="pw" id="pw" onclick="seekAudio(event)"><div class="pp" id="pp"></div></div>
      <div class="tlbl2" id="tlbl2">0:00</div>
    </div>
    <div style="margin-top:.5rem;">
      <div style="font-size:.6rem;color:rgba(255,255,255,.28);margin-bottom:.18rem;">Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„ÙƒÙ„ÙŠ</div>
      <div style="background:rgba(255,255,255,.07);border-radius:3px;height:3px;overflow:hidden;">
        <div id="total-prog" style="height:100%;background:linear-gradient(90deg,var(--acc),var(--acc2));border-radius:3px;width:0%;transition:width .3s;"></div>
      </div>
    </div>
  </div>
  <div style="font-size:.62rem;color:rgba(255,255,255,.18);text-align:center;direction:ltr;">Canvas 540Ã—960 Â· 9:16 Â· Reels / Shorts / TikTok</div>
</div>
</div>

<!-- SOCIAL -->
<div class="social-bar">
  <a class="sl wa" href="https://wa.me/201091348470" target="_blank"><span class="sli"><svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg></span><span class="slt">ÙˆØ§ØªØ³Ø§Ø¨</span></a>
  <a class="sl ig" href="https://www.instagram.com/omar_10fcb/" target="_blank"><span class="sli"><svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg></span><span class="slt">Ø§Ù†Ø³ØªÙ‚Ø±Ø§Ù…</span></a>
  <a class="sl fb" href="https://www.facebook.com/share/18U33WfPE5/" target="_blank"><span class="sli"><svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg></span><span class="slt">ÙÙŠØ³Ø¨ÙˆÙƒ</span></a>
  <a class="sl yt" href="https://youtube.com/@omar99-y4m" target="_blank"><span class="sli"><svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></span><span class="slt">ÙŠÙˆØªÙŠÙˆØ¨</span></a>
</div>
<div class="footer"><div class="dev">âœ¨ Developed by Omar Mostafa âœ¨</div></div>


<script>
'use strict';

/* â•â•â•â•â•â•â• SURAHS â•â•â•â•â•â•â• */
const SURAHS=[
  {n:1,name:'Ø§Ù„ÙØ§ØªØ­Ø©',a:7},{n:2,name:'Ø§Ù„Ø¨Ù‚Ø±Ø©',a:286},{n:3,name:'Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†',a:200},
  {n:4,name:'Ø§Ù„Ù†Ø³Ø§Ø¡',a:176},{n:5,name:'Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©',a:120},{n:6,name:'Ø§Ù„Ø£Ù†Ø¹Ø§Ù…',a:165},
  {n:7,name:'Ø§Ù„Ø£Ø¹Ø±Ø§Ù',a:206},{n:8,name:'Ø§Ù„Ø£Ù†ÙØ§Ù„',a:75},{n:9,name:'Ø§Ù„ØªÙˆØ¨Ø©',a:129},
  {n:10,name:'ÙŠÙˆÙ†Ø³',a:109},{n:11,name:'Ù‡ÙˆØ¯',a:123},{n:12,name:'ÙŠÙˆØ³Ù',a:111},
  {n:13,name:'Ø§Ù„Ø±Ø¹Ø¯',a:43},{n:14,name:'Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…',a:52},{n:15,name:'Ø§Ù„Ø­Ø¬Ø±',a:99},
  {n:16,name:'Ø§Ù„Ù†Ø­Ù„',a:128},{n:17,name:'Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡',a:111},{n:18,name:'Ø§Ù„ÙƒÙ‡Ù',a:110},
  {n:19,name:'Ù…Ø±ÙŠÙ…',a:98},{n:20,name:'Ø·Ù‡',a:135},{n:21,name:'Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡',a:112},
  {n:22,name:'Ø§Ù„Ø­Ø¬',a:78},{n:23,name:'Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†',a:118},{n:24,name:'Ø§Ù„Ù†ÙˆØ±',a:64},
  {n:25,name:'Ø§Ù„ÙØ±Ù‚Ø§Ù†',a:77},{n:26,name:'Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡',a:227},{n:27,name:'Ø§Ù„Ù†Ù…Ù„',a:93},
  {n:28,name:'Ø§Ù„Ù‚ØµØµ',a:88},{n:29,name:'Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª',a:69},{n:30,name:'Ø§Ù„Ø±ÙˆÙ…',a:60},
  {n:31,name:'Ù„Ù‚Ù…Ø§Ù†',a:34},{n:32,name:'Ø§Ù„Ø³Ø¬Ø¯Ø©',a:30},{n:33,name:'Ø§Ù„Ø£Ø­Ø²Ø§Ø¨',a:73},
  {n:34,name:'Ø³Ø¨Ø£',a:54},{n:35,name:'ÙØ§Ø·Ø±',a:45},{n:36,name:'ÙŠØ³',a:83},
  {n:37,name:'Ø§Ù„ØµØ§ÙØ§Øª',a:182},{n:38,name:'Øµ',a:88},{n:39,name:'Ø§Ù„Ø²Ù…Ø±',a:75},
  {n:40,name:'ØºØ§ÙØ±',a:85},{n:41,name:'ÙØµÙ„Øª',a:54},{n:42,name:'Ø§Ù„Ø´ÙˆØ±Ù‰',a:53},
  {n:43,name:'Ø§Ù„Ø²Ø®Ø±Ù',a:89},{n:44,name:'Ø§Ù„Ø¯Ø®Ø§Ù†',a:59},{n:45,name:'Ø§Ù„Ø¬Ø§Ø«ÙŠØ©',a:37},
  {n:46,name:'Ø§Ù„Ø£Ø­Ù‚Ø§Ù',a:35},{n:47,name:'Ù…Ø­Ù…Ø¯',a:38},{n:48,name:'Ø§Ù„ÙØªØ­',a:29},
  {n:49,name:'Ø§Ù„Ø­Ø¬Ø±Ø§Øª',a:18},{n:50,name:'Ù‚',a:45},{n:51,name:'Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª',a:60},
  {n:52,name:'Ø§Ù„Ø·ÙˆØ±',a:49},{n:53,name:'Ø§Ù„Ù†Ø¬Ù…',a:62},{n:54,name:'Ø§Ù„Ù‚Ù…Ø±',a:55},
  {n:55,name:'Ø§Ù„Ø±Ø­Ù…Ù†',a:78},{n:56,name:'Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©',a:96},{n:57,name:'Ø§Ù„Ø­Ø¯ÙŠØ¯',a:29},
  {n:58,name:'Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©',a:22},{n:59,name:'Ø§Ù„Ø­Ø´Ø±',a:24},{n:60,name:'Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©',a:13},
  {n:61,name:'Ø§Ù„ØµÙ',a:14},{n:62,name:'Ø§Ù„Ø¬Ù…Ø¹Ø©',a:11},{n:63,name:'Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†',a:11},
  {n:64,name:'Ø§Ù„ØªØºØ§Ø¨Ù†',a:18},{n:65,name:'Ø§Ù„Ø·Ù„Ø§Ù‚',a:12},{n:66,name:'Ø§Ù„ØªØ­Ø±ÙŠÙ…',a:12},
  {n:67,name:'Ø§Ù„Ù…Ù„Ùƒ',a:30},{n:68,name:'Ø§Ù„Ù‚Ù„Ù…',a:52},{n:69,name:'Ø§Ù„Ø­Ø§Ù‚Ø©',a:52},
  {n:70,name:'Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬',a:44},{n:71,name:'Ù†ÙˆØ­',a:28},{n:72,name:'Ø§Ù„Ø¬Ù†',a:28},
  {n:73,name:'Ø§Ù„Ù…Ø²Ù…Ù„',a:20},{n:74,name:'Ø§Ù„Ù…Ø¯Ø«Ø±',a:56},{n:75,name:'Ø§Ù„Ù‚ÙŠØ§Ù…Ø©',a:40},
  {n:76,name:'Ø§Ù„Ø¥Ù†Ø³Ø§Ù†',a:31},{n:77,name:'Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª',a:50},{n:78,name:'Ø§Ù„Ù†Ø¨Ø£',a:40},
  {n:79,name:'Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª',a:46},{n:80,name:'Ø¹Ø¨Ø³',a:42},{n:81,name:'Ø§Ù„ØªÙƒÙˆÙŠØ±',a:29},
  {n:82,name:'Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±',a:19},{n:83,name:'Ø§Ù„Ù…Ø·ÙÙÙŠÙ†',a:36},{n:84,name:'Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚',a:25},
  {n:85,name:'Ø§Ù„Ø¨Ø±ÙˆØ¬',a:22},{n:86,name:'Ø§Ù„Ø·Ø§Ø±Ù‚',a:17},{n:87,name:'Ø§Ù„Ø£Ø¹Ù„Ù‰',a:19},
  {n:88,name:'Ø§Ù„ØºØ§Ø´ÙŠØ©',a:26},{n:89,name:'Ø§Ù„ÙØ¬Ø±',a:30},{n:90,name:'Ø§Ù„Ø¨Ù„Ø¯',a:20},
  {n:91,name:'Ø§Ù„Ø´Ù…Ø³',a:15},{n:92,name:'Ø§Ù„Ù„ÙŠÙ„',a:21},{n:93,name:'Ø§Ù„Ø¶Ø­Ù‰',a:11},
  {n:94,name:'Ø§Ù„Ø´Ø±Ø­',a:8},{n:95,name:'Ø§Ù„ØªÙŠÙ†',a:8},{n:96,name:'Ø§Ù„Ø¹Ù„Ù‚',a:19},
  {n:97,name:'Ø§Ù„Ù‚Ø¯Ø±',a:5},{n:98,name:'Ø§Ù„Ø¨ÙŠÙ†Ø©',a:8},{n:99,name:'Ø§Ù„Ø²Ù„Ø²Ù„Ø©',a:8},
  {n:100,name:'Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª',a:11},{n:101,name:'Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©',a:11},{n:102,name:'Ø§Ù„ØªÙƒØ§Ø«Ø±',a:8},
  {n:103,name:'Ø§Ù„Ø¹ØµØ±',a:3},{n:104,name:'Ø§Ù„Ù‡Ù…Ø²Ø©',a:9},{n:105,name:'Ø§Ù„ÙÙŠÙ„',a:5},
  {n:106,name:'Ù‚Ø±ÙŠØ´',a:4},{n:107,name:'Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†',a:7},{n:108,name:'Ø§Ù„ÙƒÙˆØ«Ø±',a:3},
  {n:109,name:'Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†',a:6},{n:110,name:'Ø§Ù„Ù†ØµØ±',a:3},{n:111,name:'Ø§Ù„Ù…Ø³Ø¯',a:5},
  {n:112,name:'Ø§Ù„Ø¥Ø®Ù„Ø§Øµ',a:4},{n:113,name:'Ø§Ù„ÙÙ„Ù‚',a:5},{n:114,name:'Ø§Ù„Ù†Ø§Ø³',a:6}
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RECITERS
   CDN Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: cdn.islamic.network
   URL: https://cdn.islamic.network/quran/audio/128/{edition}/{globalAyahNum}.mp3
   globalAyahNum = Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ© Ù…Ù† 1 Ø¥Ù„Ù‰ 6236
   Fallback: everyayah.com  â†’ {s3}{a3}.mp3
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const RECITERS=[
  {name:'Ù…Ø´Ø§Ø±ÙŠ Ø±Ø§Ø´Ø¯ Ø§Ù„Ø¹ÙØ§Ø³ÙŠ',           e:'ar.alafasy',            f:'Alafasy_128kbps',            m:'server8.mp3quran.net/afs'},
  {name:'Ù…Ø§Ù‡Ø± Ø§Ù„Ù…Ø¹ÙŠÙ‚Ù„ÙŠ',                 e:'ar.mahermuaiqly',       f:'Maher_AlMuaiqly_128kbps',    m:'server7.mp3quran.net/m_ma3ali'},
  {name:'Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø³Ø¯ÙŠØ³',              e:'ar.abdurrahmaansudais', f:'Abdurrahmaan_As-Sudais_192kbps',m:'server7.mp3quran.net/sds'},
  {name:'Ø³Ø¹ÙˆØ¯ Ø§Ù„Ø´Ø±ÙŠÙ…',                   e:'ar.saoodshuraym',       f:'Al-Shuraim_64kbps',           m:'server7.mp3quran.net/shur'},
  {name:'Ø¹Ø¨Ø¯Ø§Ù„Ø¨Ø§Ø³Ø· Ø¹Ø¨Ø¯Ø§Ù„ØµÙ…Ø¯ (Ù…Ø¬ÙˆÙ‘Ø¯)',    e:'ar.abdulbaset',         f:'Abdul_Basit_Mujawwad_128kbps',m:'server7.mp3quran.net/basit'},
  {name:'Ø¹Ø¨Ø¯Ø§Ù„Ø¨Ø§Ø³Ø· Ø¹Ø¨Ø¯Ø§Ù„ØµÙ…Ø¯ (Ù…Ø±ØªÙ„)',     e:'ar.abdulbasitmurattal', f:'Abdul_Basit_Murattal_192kbps',m:'server7.mp3quran.net/basit_mujawwad'},
  {name:'Ù…Ø­Ù…ÙˆØ¯ Ø®Ù„ÙŠÙ„ Ø§Ù„Ø­ØµØ±ÙŠ (Ù…Ø±ØªÙ„)',      e:'ar.husary',             f:'Husary_128kbps',              m:'server13.mp3quran.net/husr'},
  {name:'Ù…Ø­Ù…ÙˆØ¯ Ø®Ù„ÙŠÙ„ Ø§Ù„Ø­ØµØ±ÙŠ (Ù…Ø¬ÙˆÙ‘Ø¯)',     e:'ar.husarymujawwad',     f:'Husary_Mujawwad_128kbps',     m:'server13.mp3quran.net/husary_mujawwad'},
  {name:'Ø³Ø¹Ø¯ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ',                   e:'ar.saadalghamidi',      f:'Ghamadi_40kbps',              m:'server7.mp3quran.net/ghamadi'},
  {name:'Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø·Ø§Ù…ÙŠ',                  e:'ar.nasseralqatami',     f:'Nasser_Alqatami_128kbps',     m:'server6.mp3quran.net/qtm'},
  {name:'ÙŠØ§Ø³Ø± Ø§Ù„Ø¯ÙˆØ³Ø±ÙŠ',                  e:'ar.yasseraldossari',    f:'Yasser_Ad-Dossari_128kbps',   m:'server11.mp3quran.net/yasser'},
  {name:'Ù‡Ø§Ù†ÙŠ Ø§Ù„Ø±ÙØ§Ø¹ÙŠ',                  e:'ar.hanirifai',          f:'Hani_Rifai_192kbps',          m:'server9.mp3quran.net/hani'},
  {name:'Ù…Ø­Ù…Ø¯ Ø¬Ø¨Ø±ÙŠÙ„',                    e:'ar.muhammadjibreel',    f:'Muhammad_Jibreel_128kbps',    m:'server8.mp3quran.net/jibril'},
  {name:'Ù…Ø­Ù…Ø¯ ØµØ¯ÙŠÙ‚ Ø§Ù„Ù…Ù†Ø´Ø§ÙˆÙŠ (Ù…Ø±ØªÙ„)',     e:'ar.minshawi',           f:'MinshawiMurattal128kbps',     m:'server13.mp3quran.net/minsh'},
  {name:'Ù…Ø­Ù…Ø¯ ØµØ¯ÙŠÙ‚ Ø§Ù„Ù…Ù†Ø´Ø§ÙˆÙŠ (Ù…Ø¬ÙˆÙ‘Ø¯)',    e:'ar.minshawymurattal',   f:'Minshawy_Mujawwad_128kbps',   m:'server13.mp3quran.net/minshawi_mujawwad'},
  {name:'Ù…Ø­Ù…Ø¯ Ø§Ù„Ø·Ø¨Ù„Ø§ÙˆÙŠ',                 e:'ar.muhammadaltablawi',  f:'Mohammad_al_Tablaway_128kbps',m:'server7.mp3quran.net/tablawi'},
  {name:'Ø£Ø¨Ùˆ Ø¨ÙƒØ± Ø§Ù„Ø´Ø§Ø·Ø±ÙŠ',               e:'ar.abubakrshaatery',    f:'Muhammadiyya_40kbps',         m:'server11.mp3quran.net/shatri'},
  {name:'Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø§Ù„Ø£Ø®Ø¶Ø±',                e:'ar.ibrahimakhdar',      f:'Ibrahim_Akhdar_128kbps',      m:'server10.mp3quran.net/ibrahim_akhdar'},
  {name:'Ø£Ø­Ù…Ø¯ Ø¨Ù† Ø¹Ù„ÙŠ Ø§Ù„Ø¹Ø¬Ù…ÙŠ',             e:'ar.ahmedajamy',         f:'Ahmed_ibn_Ali_al-Ajamy_128kbps_HAPPY',m:'server9.mp3quran.net/ajam'},
  {name:'Ø®Ø§Ù„Ø¯ Ø¹Ø¨Ø¯Ø§Ù„ÙƒØ§ÙÙŠ',                e:'ar.khaledabdulkafy',    f:'Khaled_Abdulkafy_128kbps',    m:'server9.mp3quran.net/khaledabdulkafy'},
  {name:'Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¨ØµÙØ±',                  e:'ar.abdullahibasfar',    f:'Basfar_192kbps',              m:'server7.mp3quran.net/basfar'},
  {name:'Ø¹Ù…Ø± Ù‡Ø´Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ',               e:'ar.omarhishamalearabi', f:'Omar_Hisham_Al_Arabi_192kbps',m:'server12.mp3quran.net/omar_hisham'},
  {name:'Ø³Ù‡Ù„ ÙŠØ§Ø³ÙŠÙ†',                     e:'ar.sahlYassin',         f:'Sahl_Yasin_128kbps',          m:'server11.mp3quran.net/sahl_yasin'},
  {name:'ÙØ§Ø±Ø³ Ø¹Ø¨Ø§Ø¯',                     e:'ar.faresabbad',         f:'Fares_Abbad_64kbps',          m:'server7.mp3quran.net/fares'},
  {name:'ÙˆØ¯ÙŠØ¹ Ø§Ù„ÙŠÙ…Ù†ÙŠ',                   e:'ar.wadialyamani',       f:'Wadee_Hammadi_Al_Yamani_128kbps',m:'server9.mp3quran.net/wadee'},
  {name:'Ø§Ù„Ø¹ÙŠÙˆÙ† Ø§Ù„ÙƒÙˆØ´ÙŠ',                 e:'ar.abdullahibasfar',    f:'Koushk_128kbps',              m:'server10.mp3quran.net/koushk'},
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ØªØ­ÙˆÙŠÙ„ (Ø³ÙˆØ±Ø© + Ø¢ÙŠØ©) â†’ Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ (1â€“6236)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const _CUMULATIVE=(()=>{
  const c=[0];
  for(let i=0;i<SURAHS.length;i++) c.push(c[i]+SURAHS[i].a);
  return c;
})();
function globalAyah(s,a){return _CUMULATIVE[s-1]+a;}

const BGS={
  g1:{c:['#04040e','#0c0c24','#07071a'],ac:'#7c3aed'},
  g2:{c:['#1a0533','#2d1b69','#4c1d95'],ac:'#a855f7'},
  g3:{c:['#022c22','#14532d','#064e3b'],ac:'#10b981'},
  g4:{c:['#431407','#7c2d12','#92400e'],ac:'#f97316'},
  g5:{c:['#0c1a3e','#1e3a5f','#0e4272'],ac:'#38bdf8'},
  rb:{c:['#1a0030','#000820','#200015'],ac:'#ff6b9d'},
  stars:{c:['#020617','#0f172a','#1e293b'],ac:'#ffd700'},
  geo:{c:['#18181b','#27272a','#3f3f46'],ac:'#f0c040'},
  dark:{c:['#000','#040404','#080808'],ac:'#ffd700'},
};

/* â•â•â•â•â•â•â• NATURE PARTICLES â•â•â•â•â•â•â• */
function mkWaterfall(){
  return Array.from({length:120},()=>({
    x:Math.random()*540,y:Math.random()*960,
    speed:4+Math.random()*8,len:15+Math.random()*35,
    op:0.08+Math.random()*0.25,w:1+Math.random()*2
  }));
}
function mkPetals(){
  return Array.from({length:45},()=>({
    x:Math.random()*540,y:Math.random()*960-200,
    size:6+Math.random()*14,rot:Math.random()*Math.PI*2,
    rotV:(Math.random()-.5)*.08,
    vx:(Math.random()-.5)*1.2,vy:0.6+Math.random()*1.4,
    hue:330+Math.random()*40,op:0.4+Math.random()*0.5
  }));
}
function mkForest(){
  return Array.from({length:80},()=>({
    x:Math.random()*540,y:Math.random()*960,
    size:3+Math.random()*9,rot:Math.random()*Math.PI*2,
    rotV:(Math.random()-.5)*.06,
    vx:(Math.random()-.5)*1.0,vy:0.3+Math.random()*0.9,
    hue:90+Math.random()*60,op:0.3+Math.random()*0.5
  }));
}
function mkRain(){
  return Array.from({length:180},()=>({
    x:Math.random()*580-20,y:Math.random()*960,
    speed:12+Math.random()*10,len:8+Math.random()*20,
    op:0.07+Math.random()*0.2
  }));
}
function mkAurora(){
  return Array.from({length:6},()=>({
    phase:Math.random()*Math.PI*2,
    speed:0.008+Math.random()*0.012,
    hue:160+Math.random()*80,
    y:H*(.2+Math.random()*.4),
    amp:60+Math.random()*80
  }));
}
function mkDesert(){
  return Array.from({length:60},()=>({
    x:Math.random()*540,y:Math.random()*960,
    r:1+Math.random()*3,
    vx:(Math.random()-.5)*1.5,vy:-0.2-Math.random()*0.5,
    op:0.1+Math.random()*0.35,hue:35+Math.random()*25
  }));
}

/* â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â• */
const S={
  surahN:1,surahName:'Ø§Ù„ÙØ§ØªØ­Ø©',reciterIdx:0,
  fromA:1,toA:7,
  queue:[],queueIdx:0,
  isPlaying:false,isStopped:true,
  currentText:'',currentChunkIdx:0,
  textAlpha:0,ayahProgress:0,
  bg:'g1',textColor:'#ffd700',fontSize:32,
  fontFamily:'Amiri Quran',lineHeight:1.88,letterSpacing:0,
  linesPerSlide:3,showVerseNum:false,
  showParts:true,showGeo:true,
  wpImage:null,wpVideo:null,
  gap:0.5,globalOffset:0,
  time:0,particles:[],stars:[],
  natureParticles:[],
  isRecording:false,mediaRecorder:null,recChunks:[],
  recStartTime:0,recTotalDur:0,
  lastBlob:null,lastMime:'video/webm',
  audioCtx:null,audioSrc:null,audioDest:null,
  turboMode:false,turboState:null,
  animType:'fade',animProgress:0,animDir:1,
};

/* â•â•â•â•â•â•â• CANVAS â•â•â•â•â•â•â• */
const canvas=document.getElementById('rc');
const ctx=canvas.getContext('2d');
const W=canvas.width,H=canvas.height;

/* â•â•â•â•â•â•â• AUDIO â•â•â•â•â•â•â• */
const audioEl=new Audio();
audioEl.crossOrigin='anonymous';
let _resolveAyah=null;

function setupAudioCtx(){
  if(S.audioCtx)return;
  try{
    S.audioCtx=new(window.AudioContext||window.webkitAudioContext)();
    S.audioSrc=S.audioCtx.createMediaElementSource(audioEl);
    S.audioDest=S.audioCtx.createMediaStreamDestination();
    S.audioSrc.connect(S.audioDest);
    S.audioSrc.connect(S.audioCtx.destination);
    log('ğŸ”Š Audio context Ø¬Ø§Ù‡Ø²','ok');
  }catch(e){log('âš ï¸ Audio ctx: '+e.message,'err');}
}

/* â•â•â•â•â•â•â• INIT PARTICLES â•â•â•â•â•â•â• */
(function(){
  S.particles=Array.from({length:55},()=>({
    x:Math.random()*W,y:Math.random()*H,r:Math.random()*2.3+.4,
    vx:(Math.random()-.5)*.45,vy:-Math.random()*.65-.18,a:Math.random()*.55+.2,hue:Math.random()*80+20}));
  S.stars=Array.from({length:90},()=>({
    x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.6+.3,a:Math.random(),tw:Math.random()*Math.PI*2}));
  S.natureParticles=mkWaterfall();
})();

/* â•â•â•â•â•â•â• DROPDOWNS â•â•â•â•â•â•â• */
function initDropdowns(){
  document.getElementById('s-surah').innerHTML=
    SURAHS.map(s=>`<option value="${s.n}">${s.n}. ${s.name} â€” ${s.a} Ø¢ÙŠØ©</option>`).join('');
  document.getElementById('s-reciter').innerHTML=
    RECITERS.map((r,i)=>`<option value="${i}">${r.name}</option>`).join('');
  populateAyahs(1);
}
function populateAyahs(n){
  const tot=SURAHS[n-1].a;
  const opts=Array.from({length:tot},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('');
  document.getElementById('s-from').innerHTML=opts;
  document.getElementById('s-to').innerHTML=opts;
  document.getElementById('s-from').value=1;
  document.getElementById('s-to').value=Math.min(7,tot);
}

/* â•â•â•â•â•â•â• CHANGE HANDLERS â•â•â•â•â•â•â• */
function onSurahChange(){
  const n=parseInt(document.getElementById('s-surah').value);
  S.surahN=n;S.surahName=SURAHS[n-1].name;
  populateAyahs(n);onRangeChange();
}
function onReciterChange(){S.reciterIdx=parseInt(document.getElementById('s-reciter').value);onRangeChange();}
async function onRangeChange(){
  let f=parseInt(document.getElementById('s-from').value);
  let t=parseInt(document.getElementById('s-to').value);
  if(t<f){document.getElementById('s-to').value=f;t=f;}
  S.fromA=f;S.toA=t;
  S.reciterIdx=parseInt(document.getElementById('s-reciter').value);
  document.getElementById('pl-tot').textContent=t-f+1;
  document.getElementById('pl-surah').textContent=S.surahName;
  await buildQueue();
}

/* â•â•â•â•â•â•â• BUILD QUEUE â•â•â•â•â•â•â• */
async function buildQueue(){
  stopAll();S.queue=[];
  document.getElementById('queue-body').innerHTML=
    '<tr><td colspan="4" style="text-align:center;padding:.8rem;color:rgba(255,255,255,.25);">â³ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ...</td></tr>';
  document.getElementById('sync-body').innerHTML=
    '<tr><td colspan="4" style="text-align:center;padding:.8rem;color:rgba(255,255,255,.25);">â³ ØªØ­Ù…ÙŠÙ„...</td></tr>';
  const ps=[];
  for(let a=S.fromA;a<=S.toA;a++) ps.push(fetchText(S.surahN,a));
  const results=await Promise.allSettled(ps);
  const rec=RECITERS[S.reciterIdx]||RECITERS[0];
  const s3=String(S.surahN).padStart(3,'0');
  results.forEach((r,i)=>{
    const a=S.fromA+i;
    const a3=String(a).padStart(3,'0');
    const gAyah=globalAyah(S.surahN,a);
    // CDN Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: cdn.islamic.network (CORS Ù…ÙØªÙˆØ­ØŒ Ù…ÙˆØ«ÙˆÙ‚)
    const cdn1=`https://cdn.islamic.network/quran/audio/128/${rec.e}/${gAyah}.mp3`;
    // Fallback 1: cdn.islamic.network Ø¨Ø¬ÙˆØ¯Ø© Ø£Ù‚Ù„ (64kbps)
    const cdn2=`https://cdn.islamic.network/quran/audio/64/${rec.e}/${gAyah}.mp3`;
    // Fallback 2: everyayah.com
    const cdn3=`https://www.everyayah.com/data/${rec.f}/${s3}${a3}.mp3`;
    // Fallback 3: mp3quran.net â€” Ø§Ù„Ø£Ù‚ÙˆÙ‰ ÙˆØ§Ù„Ø£Ø´Ù…Ù„
    const cdn4=rec.m?`https://${rec.m}/${s3}${a3}.mp3`:null;
    const audioUrls=[cdn1,cdn2,cdn3,...(cdn4?[cdn4]:[])];
    S.queue.push({
      n:a,
      arabic:r.status==='fulfilled'?r.value:'...',
      audioUrls,
      urlIdx:0,
      duration:0,syncOffset:S.globalOffset
    });
  });
  renderQueueTable();renderSyncTable();updateDurDisplay();
  log(`âœ… ${S.queue.length} Ø¢ÙŠØ© â€” ${rec.name}`,'ok');
}

async function fetchText(s,a){
  try{
    const r=await fetch(`https://api.alquran.cloud/v1/ayah/${s}:${a}`);
    const j=await r.json();
    return j.data?.text||'...';
  }catch{return '...';}
}

/* â•â•â•â•â•â•â• DURATION â•â•â•â•â•â•â• */
function calcTotalDur(){
  const sum=S.queue.reduce((acc,q)=>acc+(q.duration>0?q.duration:5),0);
  return sum+S.gap*Math.max(0,S.queue.length-1);
}
function updateDurDisplay(){
  const d=calcTotalDur();const lbl=d>0?fmt(d):'â€”';
  document.getElementById('total-dur-lbl').textContent=lbl;
  document.getElementById('exp-dur').textContent=lbl;
  document.getElementById('ayah-cnt').textContent=S.queue.length+' Ø¢ÙŠØ©';
}
function fmt(s){
  if(!s||isNaN(s))return'0:00';
  return`${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`;
}

/* â•â•â•â•â•â•â• PRELOAD â•â•â•â•â•â•â• */
async function preloadAll(){
  log('ğŸ” ÙƒØ´Ù Ù…Ø¯Ø¯ Ø§Ù„ØµÙˆØª...','info');
  await Promise.allSettled(S.queue.map(q=>new Promise(res=>{
    if(q.duration>0){res();return;}
    const tryUrl=(idx)=>{
      if(idx>=q.audioUrls.length){q.duration=5;res();return;}
      const a=new Audio();a.crossOrigin='anonymous';a.src=q.audioUrls[idx];
      a.addEventListener('loadedmetadata',()=>{q.duration=a.duration||5;res();},{once:true});
      a.addEventListener('error',()=>tryUrl(idx+1),{once:true});
      a.load();
    };
    tryUrl(0);
  })));
  renderQueueTable();updateDurDisplay();
  log('âœ… ØªÙ… ÙƒØ´Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø¯','ok');
}

/* â•â•â•â•â•â•â• TABLES â•â•â•â•â•â•â• */
function renderQueueTable(){
  document.getElementById('queue-body').innerHTML=S.queue.map((q,i)=>`
    <tr id="qr-${i}">
      <td><b>${q.n}</b></td>
      <td style="font-family:'Amiri Quran',serif;font-size:.82rem;color:var(--gold);direction:rtl;max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${q.arabic.substring(0,28)}â€¦</td>
      <td style="direction:ltr;color:rgba(255,255,255,.38);font-size:.68rem;">${q.duration>0?q.duration.toFixed(1)+'s':'â€”'}</td>
      <td><span class="sp spw" id="qs-${i}">Ø§Ù†ØªØ¸Ø§Ø±</span></td>
    </tr>`).join('');
}
function renderSyncTable(){
  document.getElementById('sync-body').innerHTML=S.queue.map((q,i)=>`
    <tr>
      <td><b>${q.n}</b></td>
      <td><div class="am">${q.arabic}</div></td>
      <td><input type="number" id="so-${i}" value="${q.syncOffset.toFixed(1)}" step="0.1" min="-5" max="10" onchange="S.queue[${i}].syncOffset=parseFloat(this.value)||0;"></td>
      <td><button class="btn btn-sky btn-sm" onclick="testAyah(${i})">â–¶</button></td>
    </tr>`).join('');
}
function applyGlobal(v){
  S.globalOffset=parseFloat(v)||0;
  document.getElementById('gov').textContent=S.globalOffset.toFixed(1)+'s';
  S.queue.forEach((q,i)=>{q.syncOffset=S.globalOffset;q.urlIdx=0;const el=document.getElementById(`so-${i}`);if(el)el.value=S.globalOffset.toFixed(1);});
}
function resetSync(){document.getElementById('global-off').value=0;applyGlobal(0);log('â†º ØªÙ… Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©','info');}

/* â•â•â•â•â•â•â• ARABIC NUMERALS â•â•â•â•â•â•â• */
function toArabicNum(n){
  return String(n).replace(/[0-9]/g,d=>'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'[d]);
}

/* â•â•â•â•â•â•â• TEXT CHUNKING â•â•â•â•â•â•â• */
function getTextChunks(text,maxLines){
  // Measure lines using canvas
  const fs=S.fontSize;
  ctx.font=`400 ${fs}px '${S.fontFamily}'`;
  ctx.letterSpacing=S.letterSpacing+'px';
  const pad=62,maxW=W-pad*2;
  const words=text.split(' ');
  const lines=[];let line='';
  for(let i=0;i<words.length;i++){
    const t=line+words[i]+' ';
    if(ctx.measureText(t).width>maxW&&i>0){lines.push(line.trim());line=words[i]+' ';}
    else line=t;
  }
  if(line.trim())lines.push(line.trim());
  // Now chunk lines into groups of maxLines
  const chunks=[];
  for(let i=0;i<lines.length;i+=maxLines){
    chunks.push(lines.slice(i,i+maxLines).join(' '));
  }
  return chunks.length?chunks:[text];
}

/* â•â•â•â•â•â•â• PLAYBACK ENGINE â•â•â•â•â•â•â• */
async function startPlayback(){
  if(S.isPlaying)return;
  await _playAll(0);
}
async function _playAll(from){
  S.isPlaying=true;S.isStopped=false;
  document.getElementById('playing-badge').style.display='inline-flex';
  document.getElementById('live-badge').style.display='none';
  document.getElementById('main-play').textContent='â¸';
  document.getElementById('btn-stop').disabled=false;
  for(let i=from;i<S.queue.length;i++){
    if(S.isStopped)break;
    S.queueIdx=i;
    await _playOne(i);
    if(!S.isStopped&&i<S.queue.length-1) await sleep(S.gap*1000);
  }
  if(!S.isStopped) onDone();
}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

async function _playOne(i){
  const q=S.queue[i];
  S.currentText=q.arabic;
  S.currentChunkIdx=0;
  S.textAlpha=0;S.ayahProgress=0;
  S.animProgress=0;
  qStat(i,'spp','ÙŠØ´ØºÙ„ â–¶');hRow(i,true);
  document.getElementById('pl-cur').textContent=i+1;
  document.getElementById('total-prog').style.width=((i/S.queue.length)*100)+'%';
  if(S.isRecording){
    document.getElementById('rec-cur').textContent=`Ø³ÙˆØ±Ø© ${S.surahName} Ø¢ÙŠØ© ${q.n}`;
  }
  if(S.audioCtx&&S.audioCtx.state==='suspended') await S.audioCtx.resume().catch(()=>{});

  // â”€â”€ Ø¬Ø±Ù‘Ø¨ ÙƒÙ„ URL Ø­ØªÙ‰ ÙŠØ´ØªØºÙ„ â”€â”€
  const tryPlay=(urlIdx)=>new Promise(res=>{
    if(urlIdx>=q.audioUrls.length){
      log(`âš ï¸ ÙØ´Ù„Øª ÙƒÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ù„Ø¢ÙŠØ© ${q.n}`,'err');res();return;
    }
    const url=q.audioUrls[urlIdx];
    if(urlIdx>0) log(`ğŸ”„ fallback ${urlIdx}: Ø¢ÙŠØ© ${q.n}`,'info');
    audioEl.src=url;
    audioEl.load();
    _resolveAyah=res;
    let timers=[];
    const cleanup=()=>{
      audioEl.removeEventListener('canplay',onCan);
      audioEl.removeEventListener('timeupdate',onTime);
      audioEl.removeEventListener('ended',onEnd);
      audioEl.removeEventListener('error',onErr);
      timers.forEach(clearTimeout);
    };
    const onCan=()=>{
      audioEl.removeEventListener('canplay',onCan);
      if(q.duration<=0){q.duration=audioEl.duration||5;updateDurDisplay();renderQueueTable();}
      const offset=q.syncOffset;
      if(offset>0){S.textAlpha=0;audioEl.play().catch(()=>{});timers.push(setTimeout(()=>{S.textAlpha=1;},offset*1000));}
      else if(offset<0){S.textAlpha=1;timers.push(setTimeout(()=>audioEl.play().catch(()=>{}),Math.abs(offset)*1000));}
      else{S.textAlpha=1;audioEl.play().catch(()=>{});}
    };
    const onTime=()=>{
      const dur=audioEl.duration||1;
      S.ayahProgress=audioEl.currentTime/dur;
      // â”€â”€ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù€ chunks Ø¨Ù†ÙØ³ Ø·Ø±ÙŠÙ‚Ø© drawText Ø¨Ø§Ù„Ø¸Ø¨Ø· â”€â”€
      ctx.font=`400 ${S.fontSize}px '${S.fontFamily}'`;
      ctx.letterSpacing=S.letterSpacing+'px';
      const _pad=62,_maxW=W-_pad*2;
      const _allLines=wrapTextCtx(S.currentText,_maxW,S.fontSize*S.lineHeight,H*.5);
      const _chunkSize=S.linesPerSlide||_allLines.length;
      const _numChunks=Math.ceil(_allLines.length/_chunkSize)||1;
      const _newIdx=Math.min(Math.floor(S.ayahProgress*_numChunks),_numChunks-1);
      // â”€â”€ Ù„Ùˆ ØªØºÙŠÙ‘Ø± Ø§Ù„Ù€ chunkØŒ Ø§Ø¹Ù…Ù„ animation Ø¬Ø¯ÙŠØ¯Ø© â”€â”€
      if(_newIdx!==S.currentChunkIdx){
        S.currentChunkIdx=_newIdx;
        S.animProgress=0; // ÙŠØ®Ù„ÙŠ Ø§Ù„Ù€ chunk Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ¯Ø®Ù„ Ø¨Ù€ animation
      }
      document.getElementById('pp').style.width=(S.ayahProgress*100)+'%';
      document.getElementById('pl-time').textContent=fmt(audioEl.currentTime);
      document.getElementById('tlbl2').textContent=fmt(audioEl.currentTime);
      if(S.isRecording){
        const el=(Date.now()-S.recStartTime)/1000;
        document.getElementById('rec-el').textContent=fmt(el);
        document.getElementById('rec-bar').style.width=Math.min(100,(el/(S.recTotalDur||1))*100)+'%';
      }
    };
    const onEnd=()=>{cleanup();qStat(i,'spd','ØªÙ… âœ“');hRow(i,false,true);res();};
    const onErr=()=>{
      cleanup();
      // Ø¬Ø±Ù‘Ø¨ Ø§Ù„Ù€ URL Ø§Ù„ØªØ§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      tryPlay(urlIdx+1).then(res);
    };
    audioEl.addEventListener('canplay',onCan,{once:true});
    audioEl.addEventListener('timeupdate',onTime);
    audioEl.addEventListener('ended',onEnd,{once:true});
    audioEl.addEventListener('error',onErr,{once:true});
  });

  await tryPlay(0);
}

function onDone(){
  S.isPlaying=false;
  document.getElementById('playing-badge').style.display='none';
  document.getElementById('live-badge').style.display='inline-flex';
  document.getElementById('main-play').textContent='â–¶';
  document.getElementById('total-prog').style.width='100%';
  document.getElementById('btn-stop').disabled=true;
  log('âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„ØªÙ„Ø§ÙˆØ©','ok');
  if(S.isRecording){
    if(S.turboMode) setTimeout(()=>stopRecordingTurbo(),600);
    else setTimeout(()=>stopRecording(),600);
  }
}
function stopAll(){
  S.isStopped=true;S.isPlaying=false;
  audioEl.pause();audioEl.currentTime=0;
  if(_resolveAyah){_resolveAyah();_resolveAyah=null;}
  document.getElementById('playing-badge').style.display='none';
  document.getElementById('live-badge').style.display='inline-flex';
  document.getElementById('main-play').textContent='â–¶';
  document.getElementById('pp').style.width='0%';
  document.getElementById('total-prog').style.width='0%';
  document.getElementById('btn-stop').disabled=true;
  S.textAlpha=0;S.ayahProgress=0;
  S.queue.forEach((_,i)=>{qStat(i,'spw','Ø§Ù†ØªØ¸Ø§Ø±');hRow(i,false,false);});
}
function togglePlay(){
  if(S.isPlaying){
    audioEl.paused?audioEl.play().catch(()=>{}):audioEl.pause();
    document.getElementById('main-play').textContent=audioEl.paused?'â–¶':'â¸';
  }else startPlayback();
}
function nextAyah(){if(S.isPlaying)audioEl.dispatchEvent(new Event('ended'));}
function prevAyah(){if(S.isPlaying){S.queueIdx=Math.max(0,S.queueIdx-2);audioEl.dispatchEvent(new Event('ended'));}}
function seekAudio(e){
  if(!audioEl.duration)return;
  const r=document.getElementById('pw').getBoundingClientRect();
  audioEl.currentTime=((e.clientX-r.left)/r.width)*audioEl.duration;
}
function testAyah(i){
  stopAll();
  setTimeout(async()=>{
    S.isStopped=false;S.isPlaying=true;S.queueIdx=i;
    document.getElementById('playing-badge').style.display='inline-flex';
    document.getElementById('btn-stop').disabled=false;
    await _playOne(i);
    if(!S.isStopped)onDone();
  },80);
}
function qStat(i,cls,txt){const el=document.getElementById(`qs-${i}`);if(el){el.className='sp '+cls;el.textContent=txt;}}
function hRow(i,act,done){
  const r=document.getElementById(`qr-${i}`);
  if(r){r.className=act?'qa':done?'qd':'';if(act)r.scrollIntoView({block:'nearest',behavior:'smooth'});}
}

/* â•â•â•â•â•â•â• RECORDING â•â•â•â•â•â•â• */
async function startRecording(){
  if(S.isRecording)return;
  if(!S.queue.length){alert('Ø§Ø®ØªØ± Ø§Ù„Ø¢ÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹');return;}
  setupAudioCtx();
  await preloadAll();
  const totalDur=calcTotalDur();
  S.recTotalDur=totalDur;
  const fps=parseInt(document.getElementById('s-fps').value);
  const bitrate=parseInt(document.getElementById('s-qual').value);
  const candidates=[
    'video/mp4;codecs=avc1.42E01E,mp4a.40.2',  // H.264 + AAC â€” Ø§Ù„Ø£ÙˆØ³Ø¹ Ø¯Ø¹Ù…Ø§Ù‹
    'video/mp4;codecs=avc1,mp4a.40.2',
    'video/mp4;codecs=h264,aac',
    'video/mp4',
    'video/webm;codecs=vp8,opus',
    'video/webm;codecs=vp9,opus',
    'video/webm;codecs=vp8',
    'video/webm',
  ];
  const mimeType=candidates.find(t=>{try{return MediaRecorder.isTypeSupported(t);}catch{return false;}})||'video/webm';
  S.lastMime=mimeType;
  log(`ğŸ“¦ ØªØ´ÙÙŠØ±: ${mimeType}`,'info');
  try{
    const videoStream=canvas.captureStream(fps);
    const audioTracks=S.audioDest?S.audioDest.stream.getAudioTracks():[];
    if(!audioTracks.length)log('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ audio track','err');
    const combined=new MediaStream([...videoStream.getVideoTracks(),...audioTracks]);
    S.recChunks=[];
    S.mediaRecorder=new MediaRecorder(combined,{mimeType,videoBitsPerSecond:bitrate});
    S.mediaRecorder.ondataavailable=e=>{if(e.data&&e.data.size>0)S.recChunks.push(e.data);};
    S.mediaRecorder.onstop=()=>finishRec();
    S.mediaRecorder.onerror=e=>log('âŒ MediaRecorder error: '+e.error,'err');
    S.mediaRecorder.start(500);
    S.isRecording=true;S.recStartTime=Date.now();S.lastBlob=null;
    setRecUI(true);
    document.getElementById('rec-tot').textContent=fmt(totalDur);
    log(`ğŸ”´ ØªØ³Ø¬ÙŠÙ„ â€” ${fmt(totalDur)} Ù…ØªÙˆÙ‚Ø¹Ø©`,'info');
    stopAll();
    setTimeout(()=>startPlayback(),400);
  }catch(e){
    log('âŒ '+e.message,'err');setRecUI(false);
    alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:\n'+e.message+'\n\nØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Chrome Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² ÙƒÙ…Ø¨ÙŠÙˆØªØ± Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø©.');
  }
}
function stopRecording(){
  if(!S.isRecording)return;
  if(S.mediaRecorder&&S.mediaRecorder.state!=='inactive')S.mediaRecorder.stop();
  stopAll();
}
function finishRec(){
  S.isRecording=false;setRecUI(false);
  if(!S.recChunks.length){log('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª','err');return;}
  const mime=S.lastMime;
  S.lastBlob=new Blob(S.recChunks,{type:mime});
  const mb=(S.lastBlob.size/1024/1024).toFixed(1);
  log(`âœ… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¬Ø§Ù‡Ø² â€” ${mb} MB`,'ok');
  // Create persistent direct download link
  const ext=mime.includes('mp4')?'mp4':'webm';
  const fname=`quran-s${S.surahN}-a${S.fromA}-${S.toA}.${ext}`;
  const url=URL.createObjectURL(S.lastBlob);
  window._lastVidUrl=url;window._lastVidBlob=S.lastBlob;window._lastVidMime=mime;
  // Inject direct <a> download link in the panel
  const area=document.getElementById('dl-direct-area');
  if(area){
    area.style.display='block';
    area.innerHTML=`
      <a href="${url}" download="${fname}"
        style="display:flex;align-items:center;justify-content:center;gap:.5rem;
          padding:.75rem;border-radius:10px;width:100%;
          background:linear-gradient(135deg,#f0c040,#f97316);
          color:#000;font-weight:800;font-size:.85rem;text-decoration:none;
          font-family:'Cairo',sans-serif;margin-bottom:.2rem;">
        â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø¨Ø§Ø´Ø±Ø© Â· ${mb} MB
      </a>`;
  }
  showVideoPopup(S.lastBlob,mime);
}

/* â•â• VIDEO POPUP â€” Ù…ÙØ­Ø³ÙÙ‘Ù† Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù…Ø¹ H.264 â•â• */
function showVideoPopup(blob,mime){
  const old=document.getElementById('vid-popup');if(old)old.remove();
  const ext=mime.includes('mp4')?'mp4':'webm';
  const fname=`quran-s${S.surahN}-a${S.fromA}-${S.toA}.${ext}`;
  const url=window._lastVidUrl||URL.createObjectURL(blob);
  window._lastVidUrl=url;window._lastVidBlob=blob;window._lastVidMime=mime;
  const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent);
  const isMP4=ext==='mp4';
  const mb=(blob.size/1024/1024).toFixed(1);
  const popup=document.createElement('div');
  popup.id='vid-popup';
  popup.style.cssText=`position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.92);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:1rem;padding:1.5rem;backdrop-filter:blur(16px);overflow-y:auto;`;
  popup.innerHTML=`
    <div style="text-align:center;max-width:480px;width:100%;font-family:'Cairo',sans-serif;">
      <div style="font-size:1.1rem;font-weight:800;color:#f0c040;margin-bottom:.8rem;">
        ğŸ¬ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¬Ø§Ù‡Ø²! â€” ${mb} MB Â· ${isMP4?'MP4 H.264':'WebM VP8'}
      </div>
      <video id="vid-player" controls playsinline webkit-playsinline
        style="width:100%;max-width:360px;border-radius:16px;background:#000;display:block;margin:0 auto .9rem;max-height:50vh;"
        src="${url}">
        Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
      </video>
      <div style="background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.25);border-radius:10px;padding:.65rem;margin-bottom:.7rem;font-size:.73rem;color:rgba(255,255,255,.75);line-height:1.9;text-align:right;">
        ${isIOS?`ğŸ <b style="color:#f0c040">iPhone:</b> Ø§Ø¶ØºØ· "ØªÙ†Ø²ÙŠÙ„ MP4" â† Ø§Ø¶ØºØ· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ â† Ø­ÙØ¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ`
               :`ğŸ“± <b style="color:#f0c040">Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯:</b> Ø§Ø¶ØºØ· "ØªÙ†Ø²ÙŠÙ„ MP4" â† ÙŠÙØ­ÙØ¸ ÙÙŠ Ø§Ù„Ø¬Ø§Ù„ÙŠØ±ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø©`}<br>
        ğŸ’» <b style="color:#f0c040">ÙƒÙ…Ø¨ÙŠÙˆØªØ±:</b> Ø§Ø¶ØºØ· "ØªÙ†Ø²ÙŠÙ„ MP4" ÙŠØ´ØªØºÙ„ Ø¹Ù„Ù‰ ÙˆÙŠÙ†Ø¯ÙˆØ²/Ù…Ø§Ùƒ/Ù„ÙŠÙ†ÙƒØ³
      </div>
      <!-- Ø±Ø§Ø¨Ø· ØªÙ†Ø²ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± â€” <a href download> Ø­Ù‚ÙŠÙ‚ÙŠ -->
      <a href="${url}" download="${fname}"
        style="display:block;width:100%;padding:.78rem;border-radius:10px;
          background:linear-gradient(135deg,#f0c040,#f97316);
          color:#000;font-weight:800;font-size:.9rem;text-decoration:none;
          text-align:center;margin-bottom:.4rem;">
        ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ ${isMP4?'MP4 (H.264+AAC)':'WebM'} â€” ${mb} MB
      </a>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:.4rem;margin-bottom:.4rem;">
        <button onclick="shareVid('${url}','${fname}')"
          style="padding:.65rem;border-radius:10px;background:linear-gradient(135deg,#059669,#10b981);color:#fff;font-weight:800;font-size:.8rem;border:none;cursor:pointer;font-family:'Cairo',sans-serif;">
          ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ©
        </button>
        <a href="${url}" target="_blank"
          style="display:flex;align-items:center;justify-content:center;padding:.65rem;border-radius:10px;background:rgba(56,189,248,.15);border:1px solid rgba(56,189,248,.3);color:#38bdf8;font-weight:700;font-size:.8rem;text-decoration:none;">
          ğŸ”— ÙØªØ­ ÙÙŠ ØªØ¨ÙˆÙŠØ¨
        </a>
      </div>
      <button onclick="document.getElementById('vid-popup').remove()"
        style="width:100%;padding:.6rem;border-radius:10px;background:rgba(255,255,255,.07);color:rgba(255,255,255,.6);border:1px solid rgba(255,255,255,.1);cursor:pointer;font-family:'Cairo',sans-serif;font-size:.82rem;font-weight:700;">
        âœ• Ø¥ØºÙ„Ø§Ù‚
      </button>
    </div>`;
  document.body.appendChild(popup);
  const vp=document.getElementById('vid-player');
  setTimeout(()=>{vp.play().catch(()=>{});},200);
}

async function shareVid(url,fname){
  if(!url&&window._lastVidBlob)url=URL.createObjectURL(window._lastVidBlob);
  if(!url)return;
  if(navigator.share){
    try{
      const b=window._lastVidBlob||S.lastBlob;
      const mime=window._lastVidMime||'video/webm';
      const f=new File([b],fname,{type:mime,lastModified:Date.now()});
      if(navigator.canShare&&navigator.canShare({files:[f]})){
        await navigator.share({title:'Ø±ÙŠÙ„Ø² Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…',text:`Ø³ÙˆØ±Ø© ${S.surahName} Ø¢ÙŠØ© ${S.fromA}â€“${S.toA}`,files:[f]});
        return;
      }
      await navigator.share({title:'Ø±ÙŠÙ„Ø² Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…',url});return;
    }catch(e){log('share: '+e.message,'err');}
  }
  window.open(url,'_blank');
}

function setRecUI(rec){
  S.isRecording=rec;
  document.getElementById('stat-badge').style.display=rec?'none':'inline-flex';
  document.getElementById('rec-badge').style.display=rec?'inline-flex':'none';
  document.getElementById('rec-live-badge').style.display=rec?'inline-flex':'none';
  document.getElementById('rec-status').style.display=rec?'block':'none';
  document.getElementById('btn-rec').disabled=rec;
  document.getElementById('btn-stop-rec').disabled=!rec;
}

function dlAs(ext){
  if(!S.lastBlob){alert('Ø³Ø¬Ù‘Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£ÙˆÙ„Ø§Ù‹!');return;}
  const mime=ext==='mp4'?'video/mp4':'video/webm';
  const url=URL.createObjectURL(new Blob([S.lastBlob],{type:mime}));
  const a=document.createElement('a');
  a.href=url;a.download=`quran-s${S.surahN}-a${S.fromA}-${S.toA}.${ext}`;
  document.body.appendChild(a);a.click();
  setTimeout(()=>{URL.revokeObjectURL(url);document.body.removeChild(a);},5000);
}
async function shareVideo(){
  if(window._lastVidUrl&&window._lastVidBlob){
    shareVid(window._lastVidUrl,`quran-s${S.surahN}-a${S.fromA}-${S.toA}.webm`);
  }else if(S.lastBlob){
    showVideoPopup(S.lastBlob,S.lastMime);
  }else{alert('Ø³Ø¬Ù‘Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£ÙˆÙ„Ø§Ù‹!');}
}
function dlFrame(){
  const l=document.createElement('a');
  l.download=`quran-s${S.surahN}-a${S.fromA}-${S.toA}.png`;
  l.href=canvas.toDataURL('image/png');l.click();
}

/* â•â•â•â•â•â•â• FORMAT SELECTION UI â•â•â•â•â•â•â• */
function onFmtChange(){
  const isMp4=document.getElementById('fmt-mp4').checked;
  document.getElementById('fmt-mp4-box').style.border=isMp4?'2px solid var(--gold)':'2px solid rgba(255,255,255,.1)';
  document.getElementById('fmt-mp4-box').style.background=isMp4?'rgba(240,192,64,.08)':'rgba(255,255,255,.03)';
  document.getElementById('fmt-mp4-dot').style.background=isMp4?'var(--gold)':'transparent';
  document.getElementById('fmt-webm-box').style.border=!isMp4?'2px solid rgba(56,189,248,.6)':'2px solid rgba(255,255,255,.1)';
  document.getElementById('fmt-webm-box').style.background=!isMp4?'rgba(56,189,248,.08)':'rgba(255,255,255,.03)';
  document.getElementById('fmt-webm-dot').style.background=!isMp4?'#38bdf8':'transparent';
  // Show/hide turbo option
  document.getElementById('turbo-box').style.display=isMp4?'block':'none';
  // Update button label
  document.getElementById('btn-rec').textContent=isMp4?'ğŸ¬ ØªØµØ¯ÙŠØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (MP4)':'ğŸ¬ ØªØµØ¯ÙŠØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (WebM)';
}

function onTurboChange(){
  checkTurboSupport();
}

function checkTurboSupport(){
  const el=document.getElementById('turbo-support');
  const enabled=document.getElementById('turbo-chk').checked;
  if(!enabled){el.innerHTML='<span style="color:rgba(255,255,255,.35);">Turbo Ù…Ø¹Ø·Ù‘Ù„ â€” Ø³ÙŠÙØ³ØªØ®Ø¯Ù… MediaRecorder</span>';return;}
  const hasWC=!!(window.VideoEncoder&&window.AudioEncoder);
  const hasMuxer=!!(window.Muxer);
  if(hasWC&&hasMuxer){
    el.innerHTML='<span style="color:#10b981;">âœ… WebCodecs Ù…Ø¯Ø¹ÙˆÙ… â€” Turbo Ø¬Ø§Ù‡Ø²!</span>';
  }else if(!hasWC){
    el.innerHTML='<span style="color:#f97316;">âš ï¸ WebCodecs ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… â€” Ø³ÙŠÙØ³ØªØ®Ø¯Ù… MediaRecorder ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</span>';
  }else{
    el.innerHTML='<span style="color:#f97316;">âš ï¸ mp4-muxer Ù„Ù… ÙŠÙØ­Ù…ÙÙ‘Ù„ Ø¨Ø¹Ø¯...</span>';
  }
}

/* â•â•â•â•â•â•â• SMART RECORDING DISPATCHER â•â•â•â•â•â•â• */
async function startRecordingSmart(){
  const isMp4=document.getElementById('fmt-mp4').checked;
  const turboEnabled=document.getElementById('turbo-chk').checked;
  if(isMp4&&turboEnabled&&window.VideoEncoder&&window.AudioEncoder&&window.Muxer){
    log('âš¡ ÙˆØ¶Ø¹ Turbo MP4 (WebCodecs)','info');
    await startRecordingTurbo();
  }else{
    log('ğŸ¬ ÙˆØ¶Ø¹ MediaRecorder','info');
    await startRecording();
  }
}
function stopRecordingSmart(){
  if(S.turboMode) stopRecordingTurbo();
  else stopRecording();
}

/* â•â•â•â•â•â•â• TURBO MP4 â€” WebCodecs + mp4-muxer â•â•â•â•â•â•â• */
async function startRecordingTurbo(){
  if(S.isRecording)return;
  if(!S.queue.length){alert('Ø§Ø®ØªØ± Ø§Ù„Ø¢ÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹');return;}
  setupAudioCtx();
  await preloadAll();
  const totalDur=calcTotalDur();
  S.recTotalDur=totalDur;
  const fps=parseInt(document.getElementById('s-fps').value);
  const bitrate=parseInt(document.getElementById('s-qual').value);

  try{
    // â”€â”€ Ù…uxer â”€â”€
    const muxer=new Muxer.Muxer({
      target:new Muxer.ArrayBufferTarget(),
      video:{codec:'avc',width:W,height:H},
      audio:{codec:'aac',sampleRate:48000,numberOfChannels:2},
      firstTimestampBehavior:'offset'
    });

    // â”€â”€ Video Encoder â”€â”€
    const videoEncoder=new VideoEncoder({
      output:(chunk,meta)=>muxer.addVideoChunk(chunk,meta),
      error:e=>log('VideoEncoder: '+e.message,'err')
    });
    videoEncoder.configure({
      codec:'avc1.42001e',
      width:W,height:H,
      bitrate,framerate:fps,
      latencyMode:'realtime'
    });

    // â”€â”€ Audio Encoder â”€â”€
    const audioEncoder=new AudioEncoder({
      output:(chunk,meta)=>muxer.addAudioChunk(chunk,meta),
      error:e=>log('AudioEncoder: '+e.message,'err')
    });
    audioEncoder.configure({codec:'mp4a.40.2',sampleRate:48000,numberOfChannels:2,bitrate:192000});

    // â”€â”€ Audio capture via ScriptProcessor â”€â”€
    await S.audioCtx.resume().catch(()=>{});
    const bufSize=4096;
    const scriptNode=S.audioCtx.createScriptProcessor(bufSize,2,2);
    let audioTS=0;
    scriptNode.onaudioprocess=ev=>{
      if(!S.isRecording)return;
      const l=ev.inputBuffer.getChannelData(0);
      const r=ev.inputBuffer.getChannelData(1);
      const buf=new Float32Array(l.length*2);
      buf.set(l,0);buf.set(r,l.length);
      try{
        const ad=new AudioData({format:'f32-planar',sampleRate:48000,numberOfFrames:l.length,numberOfChannels:2,timestamp:audioTS,data:buf});
        audioEncoder.encode(ad);ad.close();
      }catch(e){}
      audioTS+=Math.round((l.length/48000)*1e6);
    };
    S.audioSrc.connect(scriptNode);
    scriptNode.connect(S.audioCtx.destination);

    // â”€â”€ Frame capture â”€â”€
    let frameN=0;const fInterval=1000/fps;let lastFT=0;let rafId;
    function captureFrame(ts){
      if(!S.isRecording){return;}
      if(ts-lastFT>=fInterval){
        try{
          const vf=new VideoFrame(canvas,{timestamp:Math.round(frameN*(1e6/fps))});
          videoEncoder.encode(vf,{keyFrame:frameN%Math.max(1,fps*2)===0});
          vf.close();
        }catch(e){}
        frameN++;lastFT=ts;
      }
      rafId=requestAnimationFrame(captureFrame);
    }

    // â”€â”€ State â”€â”€
    S.turboMode=true;
    S.turboState={videoEncoder,audioEncoder,muxer,scriptNode,rafId:null};
    S.isRecording=true;S.recStartTime=Date.now();S.lastBlob=null;
    setRecUI(true);
    document.getElementById('rec-mode-lbl').textContent='âš¡ Turbo MP4 Ø¬Ø§Ø±ÙŠ...';
    document.getElementById('rec-tot').textContent=fmt(totalDur);
    log(`âš¡ Turbo MP4 â€” ${fmt(totalDur)} Ù…ØªÙˆÙ‚Ø¹Ø©`,'info');
    stopAll();
    setTimeout(()=>{
      rafId=requestAnimationFrame(captureFrame);
      S.turboState.rafId=rafId;
      startPlayback();
    },400);

  }catch(e){
    log('âŒ Turbo: '+e.message+' â€” ØªØ¨Ø¯ÙŠÙ„ Ù„Ù€ MediaRecorder','err');
    S.turboMode=false;
    await startRecording();
  }
}

async function stopRecordingTurbo(){
  if(!S.turboState)return;
  const {videoEncoder,audioEncoder,muxer,scriptNode,rafId}=S.turboState;
  if(rafId)cancelAnimationFrame(rafId);
  S.isRecording=false;
  stopAll();
  if(scriptNode){try{scriptNode.disconnect();}catch(e){}}
  setRecUI(false);
  S.turboMode=false;S.turboState=null;
  document.getElementById('rec-mode-lbl').textContent='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±...';
  log('â³ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© MP4...','info');
  try{
    await videoEncoder.flush();
    await audioEncoder.flush();
    muxer.finalize();
    const {buffer}=muxer.target;
    const blob=new Blob([buffer],{type:'video/mp4'});
    S.lastBlob=blob;S.lastMime='video/mp4';
    const mb=(blob.size/1024/1024).toFixed(1);
    log(`âœ… Turbo MP4 Ø¬Ø§Ù‡Ø² â€” ${mb} MB`,'ok');
    const fname=`quran-s${S.surahN}-a${S.fromA}-${S.toA}.mp4`;
    const url=URL.createObjectURL(blob);
    window._lastVidUrl=url;window._lastVidBlob=blob;window._lastVidMime='video/mp4';
    const area=document.getElementById('dl-direct-area');
    if(area){area.style.display='block';area.innerHTML=`<a href="${url}" download="${fname}" style="display:flex;align-items:center;justify-content:center;gap:.5rem;padding:.75rem;border-radius:10px;width:100%;background:linear-gradient(135deg,#f0c040,#f97316);color:#000;font-weight:800;font-size:.85rem;text-decoration:none;font-family:'Cairo',sans-serif;margin-bottom:.2rem;">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø¨Ø§Ø´Ø±Ø© Â· ${mb} MB</a>`;}
    showVideoPopup(blob,'video/mp4');
  }catch(e){log('âŒ Ù…Ø¹Ø§Ù„Ø¬Ø© MP4: '+e.message,'err');}
}

/* â•â•â•â•â•â•â• ANIMATION CONTROLS â•â•â•â•â•â•â• */
function setAnim(type){
  S.animType=type;
  document.querySelectorAll('#anim-grid .bgb').forEach(el=>el.classList.toggle('active',el.dataset.a===type));
}

/* â•â•â•â•â•â•â• FONT CONTROLS â•â•â•â•â•â•â• */
function onFontChange(val){
  S.fontFamily=val;
  const prev=document.getElementById('font-preview-txt');
  prev.style.fontFamily=`'${val}', serif`;
}
function setFontSize(sz){
  S.fontSize=sz;
  document.getElementById('fs-r').value=sz;
  document.getElementById('fs-v').textContent=sz;
  document.querySelectorAll('[id^="fs-btn-"]').forEach(el=>el.classList.remove('active'));
  const btn=document.getElementById('fs-btn-'+sz);
  if(btn)btn.classList.add('active');
}
function setFontSizeRaw(sz){
  S.fontSize=sz;
  document.getElementById('fs-v').textContent=sz;
  document.querySelectorAll('[id^="fs-btn-"]').forEach(el=>el.classList.remove('active'));
  const snap=[22,28,34,42,52];
  const nearest=snap.reduce((a,b)=>Math.abs(b-sz)<Math.abs(a-sz)?b:a);
  if(Math.abs(nearest-sz)<=3){const btn=document.getElementById('fs-btn-'+nearest);if(btn)btn.classList.add('active');}
}

/* â•â•â•â•â•â•â• DESIGN CONTROLS â•â•â•â•â•â•â• */
function sTab(t){
  const ids=['range','sync','design','text','livesync','export'];
  document.querySelectorAll('.tab').forEach((el,i)=>el.classList.toggle('active',ids[i]===t));
  document.querySelectorAll('.tc').forEach(el=>el.classList.toggle('active',el.id==='tc-'+t));
  if(t==='livesync') initLsAudio();
}
function setBg(b){
  S.bg=b;S.wpImage=null;S.wpVideo=null;
  document.getElementById('wp-name').textContent='';
  document.querySelectorAll('.bgb').forEach(el=>el.classList.toggle('active',el.dataset.b===b));
  // Init nature particles
  if(b==='waterfall')S.natureParticles=mkWaterfall();
  else if(b==='petals')S.natureParticles=mkPetals();
  else if(b==='forest')S.natureParticles=mkForest();
  else if(b==='rain')S.natureParticles=mkRain();
  else if(b==='aurora')S.natureParticles=mkAurora();
  else if(b==='desert')S.natureParticles=mkDesert();
}
function setTc(c){
  S.textColor=c;
  document.querySelectorAll('.cb').forEach(el=>el.classList.toggle('active',el.style.background===c));
}
function onWpUpload(e){
  const f=e.target.files[0];if(!f)return;
  document.getElementById('wp-name').textContent='âœ… '+f.name;
  S.bg='custom';
  document.querySelectorAll('.bgb').forEach(el=>el.classList.remove('active'));
  if(f.type.startsWith('video/')){
    // Video background
    const vid=document.createElement('video');
    vid.loop=true;vid.muted=true;vid.playsInline=true;vid.autoplay=true;
    vid.crossOrigin='anonymous';
    const reader=new FileReader();
    reader.onload=ev=>{vid.src=ev.target.result;vid.load();vid.play().catch(()=>{});S.wpVideo=vid;S.wpImage=null;};
    reader.readAsDataURL(f);
  }else{
    // Image background
    const reader=new FileReader();
    reader.onload=ev=>{const img=new Image();img.onload=()=>{S.wpImage=img;S.wpVideo=null;};img.src=ev.target.result;};
    reader.readAsDataURL(f);
  }
}
function clearWp(){
  S.wpImage=null;
  if(S.wpVideo){S.wpVideo.pause();S.wpVideo=null;}
  document.getElementById('wp-name').textContent='';
  document.getElementById('wp-input').value='';
  S.bg='g1';
  document.querySelectorAll('.bgb').forEach(el=>el.classList.toggle('active',el.dataset.b==='g1'));
}

/* â•â•â•â•â•â•â• CANVAS RENDER â•â•â•â•â•â•â• */
function drawBg(){
  // VIDEO BACKGROUND
  if(S.wpVideo&&S.wpVideo.readyState>=2){
    const v=S.wpVideo,sc=Math.max(W/v.videoWidth,H/v.videoHeight),
      dw=v.videoWidth*sc,dh=v.videoHeight*sc;
    ctx.drawImage(v,(W-dw)/2,(H-dh)/2,dw,dh);
    ctx.fillStyle='rgba(0,0,0,.42)';ctx.fillRect(0,0,W,H);return;
  }
  // IMAGE BACKGROUND
  if(S.wpImage){
    const i=S.wpImage,sc=Math.max(W/i.width,H/i.height),dw=i.width*sc,dh=i.height*sc;
    ctx.drawImage(i,(W-dw)/2,(H-dh)/2,dw,dh);
    ctx.fillStyle='rgba(0,0,0,.46)';ctx.fillRect(0,0,W,H);return;
  }
  // NATURE ANIMATED BACKGROUNDS
  const t=S.time;
  if(S.bg==='waterfall'){
    // Deep blue-teal gradient
    const grd=ctx.createLinearGradient(0,0,0,H);
    grd.addColorStop(0,'#001828');grd.addColorStop(.5,'#003348');grd.addColorStop(1,'#001018');
    ctx.fillStyle=grd;ctx.fillRect(0,0,W,H);
    // Waterfall streams
    S.natureParticles.forEach(p=>{
      p.y+=p.speed;
      if(p.y>H+p.len){p.y=-p.len;p.x=Math.random()*W;}
      ctx.beginPath();
      ctx.moveTo(p.x,p.y-p.len);ctx.lineTo(p.x,p.y);
      const g=ctx.createLinearGradient(0,p.y-p.len,0,p.y);
      g.addColorStop(0,'transparent');g.addColorStop(1,`rgba(120,220,255,${p.op})`);
      ctx.strokeStyle=g;ctx.lineWidth=p.w;ctx.stroke();
    });
    // Mist overlay
    const mist=ctx.createLinearGradient(0,H*.7,0,H);
    mist.addColorStop(0,'transparent');mist.addColorStop(1,'rgba(180,230,255,.12)');
    ctx.fillStyle=mist;ctx.fillRect(0,0,W,H);
    return;
  }
  if(S.bg==='petals'){
    // Soft pink/purple gradient
    const grd=ctx.createLinearGradient(0,0,W*.3,H);
    grd.addColorStop(0,'#1a0820');grd.addColorStop(.5,'#2d0f30');grd.addColorStop(1,'#0e0818');
    ctx.fillStyle=grd;ctx.fillRect(0,0,W,H);
    // Petals
    S.natureParticles.forEach(p=>{
      p.y+=p.vy;p.x+=p.vx+Math.sin(t*.02+p.y*.005)*0.4;
      p.rot+=p.rotV;
      if(p.y>H+20){p.y=-20;p.x=Math.random()*W;}
      ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot);
      ctx.beginPath();
      ctx.ellipse(0,0,p.size,p.size*.55,0,0,Math.PI*2);
      ctx.fillStyle=`hsla(${p.hue},75%,70%,${p.op})`;
      ctx.fill();ctx.restore();
    });
    // Soft glow
    const gl=ctx.createRadialGradient(W*.5,H*.4,0,W*.5,H*.4,W*.6);
    gl.addColorStop(0,'rgba(255,150,200,.06)');gl.addColorStop(1,'transparent');
    ctx.fillStyle=gl;ctx.fillRect(0,0,W,H);
    return;
  }
  if(S.bg==='forest'){
    // Deep forest green
    const grd=ctx.createLinearGradient(0,0,0,H);
    grd.addColorStop(0,'#020f04');grd.addColorStop(.6,'#041808');grd.addColorStop(1,'#020c03');
    ctx.fillStyle=grd;ctx.fillRect(0,0,W,H);
    // Floating leaves
    S.natureParticles.forEach(p=>{
      p.y+=p.vy;p.x+=p.vx+Math.sin(t*.015+p.y*.004)*0.5;
      p.rot+=p.rotV;
      if(p.y>H+20){p.y=-20;p.x=Math.random()*W;}
      ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot);
      ctx.beginPath();
      ctx.moveTo(0,-p.size);ctx.quadraticCurveTo(p.size*.6,0,0,p.size);
      ctx.quadraticCurveTo(-p.size*.6,0,0,-p.size);
      ctx.fillStyle=`hsla(${p.hue},65%,35%,${p.op})`;
      ctx.fill();ctx.restore();
    });
    // Light rays
    for(let i=0;i<3;i++){
      const rx=W*(.2+i*.3);
      const gr=ctx.createLinearGradient(rx,0,rx+50,H*.7);
      gr.addColorStop(0,'rgba(120,220,80,.04)');gr.addColorStop(1,'transparent');
      ctx.fillStyle=gr;ctx.fillRect(rx-15,0,30,H);
    }
    return;
  }
  if(S.bg==='rain'){
    // Dark stormy
    const grd=ctx.createLinearGradient(0,0,0,H);
    grd.addColorStop(0,'#080c14');grd.addColorStop(1,'#040810');
    ctx.fillStyle=grd;ctx.fillRect(0,0,W,H);
    // Rain drops
    S.natureParticles.forEach(p=>{
      p.y+=p.speed;p.x-=p.speed*.15;
      if(p.y>H+p.len){p.y=-p.len;p.x=Math.random()*580-20;}
      ctx.beginPath();
      ctx.moveTo(p.x,p.y-p.len);ctx.lineTo(p.x-p.len*.15,p.y);
      const g=ctx.createLinearGradient(p.x,p.y-p.len,p.x,p.y);
      g.addColorStop(0,'transparent');g.addColorStop(1,`rgba(150,200,255,${p.op})`);
      ctx.strokeStyle=g;ctx.lineWidth=1;ctx.stroke();
    });
    return;
  }
  if(S.bg==='aurora'){
    ctx.fillStyle='#020510';ctx.fillRect(0,0,W,H);
    // Stars
    S.stars.forEach(s=>{s.tw+=.015;ctx.beginPath();ctx.arc(s.x,s.y,s.r*.6,0,Math.PI*2);
      ctx.fillStyle=`rgba(200,220,255,${(Math.sin(s.tw)*.3+.5)*s.a*.7})`;ctx.fill();});
    // Aurora waves
    S.natureParticles.forEach((p,i)=>{
      p.phase+=p.speed;
      ctx.beginPath();
      for(let x=0;x<=W;x+=8){
        const y=p.y+Math.sin(x*.006+p.phase)*p.amp+Math.sin(x*.011+p.phase*.7)*p.amp*.4;
        i===0&&x===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
      }
      ctx.strokeStyle=`hsla(${p.hue},90%,60%,.12)`;ctx.lineWidth=30;
      ctx.lineCap='round';ctx.stroke();
      ctx.strokeStyle=`hsla(${p.hue},90%,80%,.07)`;ctx.lineWidth=8;ctx.stroke();
    });
    return;
  }
  if(S.bg==='desert'){
    // Sandy gradient
    const grd=ctx.createLinearGradient(0,0,0,H);
    grd.addColorStop(0,'#1a0f04');grd.addColorStop(.5,'#2d1a08');grd.addColorStop(1,'#1a0e04');
    ctx.fillStyle=grd;ctx.fillRect(0,0,W,H);
    // Sand particles drifting
    S.natureParticles.forEach(p=>{
      p.x+=p.vx;p.y+=p.vy;
      if(p.y<-5){p.y=H+5;p.x=Math.random()*W;}
      if(p.x>W+5)p.x=-5;if(p.x<-5)p.x=W+5;
      ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fillStyle=`hsla(${p.hue},60%,55%,${p.op*(0.5+Math.sin(t*.04+p.x*.01)*.3)})`;
      ctx.fill();
    });
    // Heat shimmer
    const gl=ctx.createRadialGradient(W*.5,H*.65,0,W*.5,H*.65,W*.8);
    gl.addColorStop(0,'rgba(255,140,0,.05)');gl.addColorStop(1,'transparent');
    ctx.fillStyle=gl;ctx.fillRect(0,0,W,H);
    return;
  }
  // â”€â”€ CLASSIC BACKGROUNDS â”€â”€
  const cfg=BGS[S.bg]||BGS['g1'],tt=t*.011;
  if(S.bg==='rb'){
    const grd=ctx.createLinearGradient(0,0,W*Math.cos(tt),H);
    [0,40,120,200,270,320,360].forEach((h,i,a)=>grd.addColorStop(i/(a.length-1),`hsla(${h+tt*28},65%,13%,1)`));
    ctx.fillStyle=grd;ctx.fillRect(0,0,W,H);
    for(let i=0;i<3;i++){
      const cx2=W*.5+Math.cos(tt+i*2.1)*W*.35,cy2=H*.5+Math.sin(tt+i*2.1)*H*.25;
      const rg=ctx.createRadialGradient(cx2,cy2,0,cx2,cy2,W*.6);
      rg.addColorStop(0,`hsla(${(i*120+tt*35)%360},80%,50%,.16)`);rg.addColorStop(1,'transparent');
      ctx.fillStyle=rg;ctx.fillRect(0,0,W,H);
    }
  }else if(S.bg==='stars'){
    ctx.fillStyle=cfg.c[0];ctx.fillRect(0,0,W,H);
    S.stars.forEach(s=>{s.tw+=.022;ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
      ctx.fillStyle=`rgba(255,255,215,${(Math.sin(s.tw)*.4+.6)*s.a})`;ctx.fill();});
    const rg=ctx.createRadialGradient(W*.5,H*.38,0,W*.5,H*.38,W*.7);
    rg.addColorStop(0,'rgba(100,50,230,.14)');rg.addColorStop(1,'transparent');
    ctx.fillStyle=rg;ctx.fillRect(0,0,W,H);
  }else if(S.bg==='geo'){
    ctx.fillStyle=cfg.c[0];ctx.fillRect(0,0,W,H);
    const sz=88;ctx.lineWidth=1;
    for(let x=0;x<W+sz;x+=sz)for(let y=0;y<H+sz;y+=sz){
      ctx.strokeStyle=`rgba(240,192,64,${.04+Math.sin(tt+x*.018)*.018})`;
      ctx.strokeRect(x+Math.sin(tt+x*.01+y*.01)*10-sz/2,y+Math.sin(tt+x*.01+y*.01)*10-sz/2,sz-4,sz-4);
    }
  }else{
    const a=tt*.5;
    const grd=ctx.createLinearGradient(W*.5+Math.cos(a)*W*.5,H*.3,W*.5-Math.cos(a)*W*.5,H*.7);
    grd.addColorStop(0,cfg.c[0]);grd.addColorStop(.5,cfg.c[1]);grd.addColorStop(1,cfg.c[2]);
    ctx.fillStyle=grd;ctx.fillRect(0,0,W,H);
    const rg=ctx.createRadialGradient(W*.5+Math.cos(tt*.6)*W*.2,H*.38+Math.sin(tt*.45)*H*.1,0,W*.5,H*.38,W*.75);
    rg.addColorStop(0,(cfg.ac||'#7c3aed')+'22');rg.addColorStop(1,'transparent');
    ctx.fillStyle=rg;ctx.fillRect(0,0,W,H);
  }
  const vig=ctx.createRadialGradient(W/2,H/2,0,W/2,H/2,W*.82);
  vig.addColorStop(.5,'transparent');vig.addColorStop(1,'rgba(0,0,0,.7)');
  ctx.fillStyle=vig;ctx.fillRect(0,0,W,H);
}

function drawGeo(){
  if(!S.showGeo)return;
  const t=S.time*.0058;
  ctx.save();ctx.globalAlpha=.04;ctx.strokeStyle='#ffd700';ctx.lineWidth=1.1;
  ctx.translate(W*.5,H*.11);ctx.rotate(t*.32);
  for(let i=0;i<8;i++){ctx.save();ctx.rotate(i*Math.PI/4);
    ctx.beginPath();ctx.moveTo(0,-86);ctx.lineTo(21,-21);ctx.lineTo(86,0);ctx.lineTo(21,21);ctx.lineTo(0,86);ctx.stroke();ctx.restore();}
  for(let r=30;r<=86;r+=28){ctx.beginPath();ctx.arc(0,0,r,0,Math.PI*2);ctx.stroke();}
  ctx.restore();
}

function drawParticles(){
  if(!S.showParts)return;
  S.particles.forEach(p=>{
    p.x+=p.vx;p.y+=p.vy;
    if(p.y<-8){p.y=H+8;p.x=Math.random()*W;}
    if(p.x<0)p.x=W;if(p.x>W)p.x=0;
    ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    ctx.fillStyle=`hsla(${p.hue+S.time*.5},80%,70%,${p.a*(.5+Math.sin(S.time*.05+p.x*.012)*.3)})`;
    ctx.fill();
  });
}

function wrapTextCtx(text,maxW,lh,y0){
  const words=text.split(' ');let line='',y=y0,lines=[];
  for(let i=0;i<words.length;i++){
    const t=line+words[i]+' ';
    if(ctx.measureText(t).width>maxW&&i>0){lines.push({text:line,y});line=words[i]+' ';y+=lh;}
    else line=t;
  }
  lines.push({text:line,y});return lines;
}
function rrect(x,y,w,h,r){
  ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h+r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();
}

function drawText(){
  if(!S.currentText)return;
  const alpha=Math.min(1,Math.max(0,S.textAlpha));
  const p=Math.min(1,S.animProgress); // 0â†’1 eased progress
  const ep=easeOutBack(p); // eased for bounce/zoom
  const es=easeOutCubic(p); // smooth ease

  ctx.save();ctx.globalAlpha=alpha;

  // â”€â”€ Apply transition transform â”€â”€
  const cx2=W/2,cy2=H/2;
  ctx.save();
  ctx.translate(cx2,cy2);
  switch(S.animType){
    case 'slideUp':
      ctx.translate(0,(1-es)*120);break;
    case 'slideDown':
      ctx.translate(0,-(1-es)*120);break;
    case 'slideRight':
      ctx.translate((1-es)*160,0);break;
    case 'slideLeft':
      ctx.translate(-(1-es)*160,0);break;
    case 'zoomIn':{
      const sc=0.4+es*0.6;
      ctx.scale(sc,sc);break;}
    case 'zoomOut':{
      const sc2=1.6-es*0.6;
      ctx.scale(sc2,sc2);break;}
    case 'flipY':{
      const scaleX=Math.abs(Math.cos((1-p)*Math.PI));
      ctx.scale(Math.max(0.01,scaleX),1);break;}
    case 'bounce':{
      const by=(1-ep)*-80;
      ctx.translate(0,by);break;}
    case 'glow':
      ctx.globalAlpha=alpha*es;break;
    // 'fade' default â€” no transform
  }
  ctx.translate(-cx2,-cy2);

  const pad=62,cx=W/2,maxW=W-pad*2,cy=H*.5;
  const fs=S.fontSize;
  const lh=S.lineHeight;
  const ls=S.letterSpacing;
  ctx.letterSpacing=ls+'px';

  // â”€â”€ Glow overlay for glow animation â”€â”€
  if(S.animType==='glow'&&p<0.6){
    ctx.shadowColor=S.textColor;ctx.shadowBlur=60*(1-p/0.6);
  }

  // â”€â”€ Surah badge â”€â”€
  if(document.getElementById('t-sname').checked&&S.queue[S.queueIdx]){
    const q=S.queue[S.queueIdx];
    const badge=`Ø³ÙˆØ±Ø© ${S.surahName}  â€¢  Ø¢ÙŠØ© ${q.n} / ${SURAHS[S.surahN-1].a}`;
    ctx.font=`600 26px 'Cairo'`;ctx.letterSpacing='0px';ctx.textAlign='center';
    const bw=ctx.measureText(badge).width+46,by=H*.19;
    ctx.fillStyle='rgba(0,0,0,.35)';rrect(cx-bw/2,by,bw,40,20);ctx.fill();
    ctx.strokeStyle=S.textColor+'60';ctx.lineWidth=1.4;rrect(cx-bw/2,by,bw,40,20);ctx.stroke();
    ctx.fillStyle=S.textColor;ctx.fillText(badge,cx,by+27);
  }

  // â”€â”€ Get current text chunk â”€â”€
  ctx.font=`400 ${fs}px '${S.fontFamily}'`;
  ctx.letterSpacing=ls+'px';
  ctx.textAlign='center';ctx.direction='rtl';
  const allLines=wrapTextCtx(S.currentText,maxW,fs*lh,cy);
  const chunkSize=S.linesPerSlide||allLines.length;
  const numChunks=Math.ceil(allLines.length/chunkSize);
  const ci=Math.min(S.currentChunkIdx||0,numChunks-1);
  const visibleLines=allLines.slice(ci*chunkSize,(ci+1)*chunkSize);

  // â”€â”€ Verse number suffix â”€â”€
  if(S.showVerseNum&&S.queue[S.queueIdx]){
    const vn=S.queue[S.queueIdx].n;
    if(ci===numChunks-1&&visibleLines.length>0){
      visibleLines[visibleLines.length-1].text=visibleLines[visibleLines.length-1].text.trim()+` ï´¿${toArabicNum(vn)}ï´¾`;
    }
  }

  const totalH=visibleLines.length*fs*lh;
  // â”€â”€ FIX: Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ù…ÙˆØ§Ø¶Ø¹ Ø§Ù„Ø³Ø·ÙˆØ± Ù…Ù† Ø§Ù„Ù…Ù†ØªØµÙ Ø§Ù„Ø«Ø§Ø¨Øª Ø¯Ø§Ø¦Ù…Ø§Ù‹ â”€â”€
  const fixedCenterY=H*0.5;
  const startLineY=fixedCenterY-totalH/2+fs*0.78;
  visibleLines.forEach((l,li)=>{l.y=startLineY+li*fs*lh;});
  const baseOff=0; // Ù…ÙØ¹Ø·ÙÙ‘Ù„ â€” Ù†Ø³ØªØ®Ø¯Ù… l.y Ù…Ø¨Ø§Ø´Ø±Ø©
  visibleLines.forEach(l=>{
    const ly=l.y+baseOff;
    ctx.shadowColor='rgba(0,0,0,.6)';ctx.shadowBlur=20;
    ctx.fillStyle='rgba(0,0,0,.45)';ctx.fillText(l.text.trim(),cx+2,ly+2);
    ctx.shadowColor=S.textColor;ctx.shadowBlur=18;
    ctx.fillStyle=S.textColor;ctx.fillText(l.text.trim(),cx,ly);
  });
  ctx.shadowBlur=0;

  // â”€â”€ Divider â”€â”€
  const divY=visibleLines[visibleLines.length-1].y+baseOff+28;
  const gd=ctx.createLinearGradient(cx-180,0,cx+180,0);
  gd.addColorStop(0,'transparent');gd.addColorStop(.5,S.textColor+'90');gd.addColorStop(1,'transparent');
  ctx.strokeStyle=gd;ctx.lineWidth=1.3;ctx.letterSpacing='0px';
  ctx.beginPath();ctx.moveTo(cx-180,divY);ctx.lineTo(cx+180,divY);ctx.stroke();

  // â”€â”€ Watermark â”€â”€
  ctx.letterSpacing='0px';ctx.direction='ltr';ctx.font=`400 20px 'Cairo'`;ctx.textAlign='center';
  ctx.fillStyle='rgba(255,255,255,.18)';ctx.shadowBlur=0;
  ctx.fillText('Ø±ÙŠÙ„Ø² Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…',cx,H-42);

  ctx.restore(); // undo transform
  ctx.restore(); // undo globalAlpha
}

/* â•â• Easing functions â•â• */
function easeOutCubic(t){return 1-Math.pow(1-t,3);}
function easeOutBack(t){const c1=1.70158,c3=c1+1;return 1+c3*Math.pow(t-1,3)+c1*Math.pow(t-1,2);}

/* â•â•â•â•â•â•â• RENDER LOOP â•â•â•â•â•â•â• */
function renderFrame(){
  ctx.clearRect(0,0,W,H);
  drawBg();drawGeo();drawParticles();drawText();
  S.time++;
  if(S.isPlaying&&S.textAlpha<1)S.textAlpha=Math.min(1,S.textAlpha+.04);
  if(S.animProgress<1) S.animProgress=Math.min(1,S.animProgress+.045);
}
(function loop(){renderFrame();requestAnimationFrame(loop);})();

/* â•â•â•â•â•â•â• LOG â•â•â•â•â•â•â• */
function log(msg,type=''){
  const b=document.getElementById('log-box');
  const p=document.createElement('p');p.className='lp '+type;p.textContent=msg;
  b.appendChild(p);b.scrollTop=b.scrollHeight;
}

/* â•â•â•â•â•â•â• LIVE SYNC (Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¨Ø§Ø´Ø±Ø©) â•â•â•â•â•â•â• */
const LS = {
  audioEl: null,      // Ø¹Ù†ØµØ± Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø®ØµØµ
  customBlob: null,
  playing: false,
  startTime: 0,       // Date.now() Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
  audioStartOffset: 0,// ÙˆÙ‚Øª Ø§Ù„Ù€ audio Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ play
  marks: [],          // [{verseIdx, timeInAudio}]
  verseIdx: 0,        // Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  intervalId: null,
};

function initLsAudio(){
  if(!LS.audioEl){
    LS.audioEl = document.getElementById('ls-audio-el');
    LS.audioEl.addEventListener('ended', ()=>{ lsStop(); });
  }
}

function onLsAudioUpload(e){
  const file = e.target.files[0]; if(!file) return;
  initLsAudio();
  const url = URL.createObjectURL(file);
  LS.audioEl.src = url;
  LS.customBlob = file;
  document.getElementById('ls-audio-name').textContent = 'âœ… ' + file.name;
  document.getElementById('ls-audio-bar').style.display = 'block';
  document.getElementById('ls-audio-upa').style.borderColor = 'var(--em)';
  log('ğŸµ ØµÙˆØª Ù…Ø®ØµØµ: ' + file.name, 'ok');
}

function clearLsAudio(){
  initLsAudio();
  LS.audioEl.src = '';
  LS.customBlob = null;
  document.getElementById('ls-audio-name').textContent = '';
  document.getElementById('ls-audio-bar').style.display = 'none';
  document.getElementById('ls-audio-upa').style.borderColor = '';
}

function lsTogglePlay(){
  if(!S.queue.length){ alert('Ø­Ø¯Ø¯ Ø§Ù„Ø¢ÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† ØªØ§Ø¨ Ø§Ù„Ø¢ÙŠØ§Øª'); return; }
  initLsAudio();

  if(LS.playing){
    // Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª
    LS.audioEl.pause();
    audioEl.pause();
    LS.playing = false;
    document.getElementById('ls-play-btn').textContent = 'â–¶ Ù…ØªØ§Ø¨Ø¹Ø©';
    clearInterval(LS.intervalId);
  } else {
    // ØªØ´ØºÙŠÙ„
    LS.playing = true;
    document.getElementById('ls-play-btn').textContent = 'â¸ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
    document.getElementById('ls-mark-btn').disabled = false;

    if(LS.marks.length === 0){
      // Ø¨Ø¯Ø§ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©
      LS.verseIdx = 0;
      LS.marks = [];
      lsUpdateUI();

      // Ø´ØºÙ‘Ù„ Ø§Ù„ØµÙˆØª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø¢ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰
      if(!LS.customBlob && S.queue.length){
        S.queueIdx = 0;
        S.currentText = S.queue[0].arabic;
        S.textAlpha = 1; S.animProgress = 1;
        lsPlayDefaultAudio(0);
      }

      // Ø´ØºÙ‘Ù„ Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø®ØµØµ Ø¥Ù† ÙˆÙØ¬Ø¯
      if(LS.customBlob){
        LS.audioEl.currentTime = 0;
        LS.audioEl.play().catch(()=>{});
      }
    } else {
      // Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¹Ø¯ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª
      if(LS.customBlob) LS.audioEl.play().catch(()=>{});
      else lsPlayDefaultAudio(LS.verseIdx);
    }

    // Ø­Ù„Ù‚Ø© ØªØ­Ø¯ÙŠØ« UI
    LS.intervalId = setInterval(lsTick, 80);
  }
}

function lsPlayDefaultAudio(idx){
  if(idx >= S.queue.length) return;
  const q = S.queue[idx];
  S.currentText = q.arabic;
  S.textAlpha = 1; S.animProgress = 0;
  S.queueIdx = idx;
  // Ø´ØºÙ‘Ù„ ØµÙˆØª Ø§Ù„Ù‚Ø§Ø±Ø¦
  const tryUrl = (ui) => {
    if(ui >= q.audioUrls.length) return;
    audioEl.src = q.audioUrls[ui];
    audioEl.load();
    audioEl.play().catch(()=> tryUrl(ui+1));
    audioEl.onerror = ()=> tryUrl(ui+1);
  };
  tryUrl(q.urlIdx || 0);
}

function lsTick(){
  // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù… Ø§Ù„ØµÙˆØª ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
  if(!LS.customBlob && audioEl.duration){
    S.ayahProgress = audioEl.currentTime / audioEl.duration;
    document.getElementById('pp').style.width = (S.ayahProgress*100) + '%';
  }
}

function lsMark(){
  if(!LS.playing || !S.queue.length) return;

  const now = LS.customBlob
    ? (LS.audioEl.currentTime || 0)
    : (audioEl.currentTime || 0);

  // Ø³Ø¬Ù‘Ù„ ØªÙˆÙ‚ÙŠØª Ù‡Ø°Ù‡ Ø§Ù„Ø¢ÙŠØ©
  LS.marks.push({ verseIdx: LS.verseIdx, time: now });

  // Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ©
  LS.verseIdx++;

  if(LS.verseIdx < S.queue.length){
    S.currentText = S.queue[LS.verseIdx].arabic;
    S.textAlpha = 0; S.animProgress = 0;
    setTimeout(()=>{ S.textAlpha=1; S.animProgress=0; }, 50);

    if(!LS.customBlob){
      // Ø´ØºÙ‘Ù„ ØµÙˆØª Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø±Ø¦
      audioEl.dispatchEvent(new Event('ended'));
      setTimeout(()=> lsPlayDefaultAudio(LS.verseIdx), 100);
    }
  } else {
    // Ø§Ù†ØªÙ‡ÙŠÙ†Ø§
    lsStop();
  }

  lsUpdateUI();
  lsFlashMarkBtn();
}

function lsFlashMarkBtn(){
  const btn = document.getElementById('ls-mark-btn');
  btn.style.background = 'linear-gradient(135deg,#f0c040,#f97316)';
  btn.style.color = '#000';
  setTimeout(()=>{
    btn.style.background = '';
    btn.style.color = '';
  }, 200);
}

function lsStop(){
  LS.playing = false;
  clearInterval(LS.intervalId);
  if(LS.audioEl) LS.audioEl.pause();
  audioEl.pause();
  document.getElementById('ls-play-btn').textContent = 'â–¶ Ø´ØºÙ‘Ù„';
  document.getElementById('ls-mark-btn').disabled = true;
  lsUpdateUI();
  if(LS.marks.length > 0) log('â±ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ' + LS.marks.length + ' ØªÙˆÙ‚ÙŠØª â€” Ø§Ø¶ØºØ· "ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©"', 'ok');
}

function lsUpdateUI(){
  const idx = Math.min(LS.verseIdx, S.queue.length - 1);
  const q = S.queue[idx];
  document.getElementById('ls-verse-num').textContent = q ? q.n : 'â€”';
  document.getElementById('ls-total-num').textContent = S.queue.length;
  document.getElementById('ls-cur-verse-txt').textContent = q ? q.arabic.substring(0,55) + (q.arabic.length>55?'â€¦':'') : 'â€”';

  // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
  if(LS.marks.length === 0){
    document.getElementById('ls-result-body').innerHTML =
      '<tr><td colspan="4" style="text-align:center;padding:.8rem;color:rgba(255,255,255,.25);">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬...</td></tr>';
    return;
  }
  document.getElementById('ls-result-body').innerHTML = LS.marks.map((m,i) => {
    const q2 = S.queue[m.verseIdx];
    return `<tr>
      <td><b>${q2 ? q2.n : m.verseIdx+1}</b></td>
      <td><div class="am">${q2 ? q2.arabic.substring(0,25)+'â€¦' : ''}</div></td>
      <td style="direction:ltr;color:var(--em);font-weight:700;">${m.time.toFixed(2)}s</td>
      <td><span class="sp spd">âœ“</span></td>
    </tr>`;
  }).join('');
}

function lsApplyToSync(){
  if(!LS.marks.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙˆÙ‚ÙŠØªØ§Øª Ø¨Ø¹Ø¯ â€” Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }

  // Ø­ÙˆÙ‘Ù„ Ø§Ù„ØªÙˆÙ‚ÙŠØªØ§Øª Ù„Ù€ syncOffset
  // ÙƒÙ„ syncOffset = ÙˆÙ‚Øª Ø¸Ù‡ÙˆØ± Ø§Ù„Ù†Øµ Ù‚Ø¨Ù„/Ø¨Ø¹Ø¯ Ø¨Ø¯Ø§ÙŠØ© ØµÙˆØª Ø§Ù„Ù‚Ø§Ø±Ø¦
  // Ù‡Ù†Ø§ Ù†Ø­ÙˆÙ‘Ù„ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙÙŠ Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø®ØµØµ Ù„Ù€ offset Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„ØµÙˆØª Ø§Ù„Ù‚Ø§Ø±Ø¦
  LS.marks.forEach(m => {
    const idx = m.verseIdx;
    if(idx < S.queue.length){
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØµÙˆØª Ù…Ø®ØµØµØŒ Ù†Ø¶Ø¹ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ ÙƒÙ€ offset
      // Ø¥Ø°Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµÙˆØª Ù…Ø®ØµØµØŒ Ù†Ø³ØªØ®Ø¯Ù… ÙˆÙ‚Øª Ø§Ù„Ø¶ØºØ· ÙƒÙ€ offset Ø³Ù„Ø¨ÙŠ
      const offset = LS.customBlob ? 0 : 0; // ÙŠÙ…ÙƒÙ† ØªØ®ØµÙŠØµÙ‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
      S.queue[idx].syncOffset = LS.customBlob ? -(m.time) : 0;
      const el = document.getElementById(`so-${idx}`);
      if(el) el.value = S.queue[idx].syncOffset.toFixed(1);
    }
  });

  renderSyncTable();
  sTab('sync');
  log('âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ØªÙˆÙ‚ÙŠØªØ§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©', 'ok');
  alert('âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆÙ‚ÙŠØªØ§Øª! Ø±Ø§Ø¬Ø¹ ØªØ§Ø¨ "Ø§Ù„ØªÙˆÙ‚ÙŠØª" Ù„Ø¶Ø¨Ø·Ù‡Ø§ Ø¨Ø¯Ù‚Ø© Ø£ÙƒØ¨Ø±.');
}

function lsReset(){
  lsStop();
  LS.marks = [];
  LS.verseIdx = 0;
  if(LS.audioEl){ LS.audioEl.currentTime = 0; }
  audioEl.currentTime = 0;
  S.textAlpha = 0; S.currentText = '';
  lsUpdateUI();
  log('â†º ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©', 'info');
}

// Space key listener Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
document.addEventListener('keydown', e => {
  const activeTab = document.querySelector('.tab.active');
  if(activeTab && activeTab.textContent.includes('Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¨Ø§Ø´Ø±Ø©')){
    if(e.code === 'Space' && LS.playing){
      e.preventDefault();
      lsMark();
    }
  }
});

/* â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â• */
initDropdowns();
setTimeout(onRangeChange,400);
setTimeout(checkTurboSupport,800);
</script>
</body>
</html>
